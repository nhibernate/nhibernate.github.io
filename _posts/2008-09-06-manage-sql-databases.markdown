---
layout: post
title: "Manage SQL Databases"
date: 2008-09-06 20:54:15 +1200
comments: true
published: true
categories: ["blogs", "nhibernate", "archive"]
tags: ["database", "continuous integration"]
redirect_from: ["/blogs/nhibernate/archive/2008/09/06/manage-sql-databases.aspx/", "/blogs/nhibernate/archive/2008/09/06/manage-sql-databases.html"]
author: gabriel.schenker
gravatar: c6b14f5727ae60868a29322c6395bd4d
---
{% include imported_disclaimer.html %}
<p><strong><a href="http://www.nhforge.org/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/Blog-Signature-Gabriel_5F00_4.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="21" alt="Blog Signature Gabriel" src="/images/posts/2008/09/06/Blog-Signature-Gabriel_5F00_thumb_5F00_1.png" width="244" border="0"></a> </strong></p> <p><strong>Note</strong>: the following article is only targeting Microsoft <strong>SQL Server</strong> (I regret...).</p> <p>In a <a href="http://blogs.hibernatingrhinos.com/nhibernate/archive/2008/04/28/create-and-update-database-schema.aspx">previous article</a> I have discussed the schema generation and schema update offered by NHibernate. In this post I want to discuss a way how you can generate and/or maintain your SQL Server database.</p> <p>When practicing agile development one of the most important cornerstones of this methodology is implementing <a href="http://martinfowler.com/articles/continuousIntegration.html">continuous integration</a> (CI). That is any solution your team develops should be able to build in fully automated manner. One of the build steps is of course the creation and or update of the database and the database schema.</p> <h2>Tools to automate the build process</h2> <p>Many people use either <a href="http://nant.sourceforge.net/">nant</a> or <a href="http://en.wikipedia.org/wiki/MSBuild">msbuild</a> to fully automate their build. And when I say build it includes the following tasks(others are possible)</p> <ul> <li>versioning/tagging the sources  <li>compiling the sources (in Visual Studio called <strong>build</strong>)  <li>running unit tests, integration tests, acceptance tests, stress tests  <li><font color="#0080ff"><strong>dropping and re-creating the database</strong></font>  <li><font color="#0080ff"><strong>re-creating the database schema</strong></font>  <li>creating a package  <li>if Web: deploy the web site  <li>if Other: create installer </li></ul> <p>In this post I'll discuss the two tasks marked in blue.</p> <h2>The nant task</h2> <p>There is an OSS project on <strong>Google Code</strong> which is dedicated to the change management of SQL server databases. It's called <strong>Tarantino</strong> and can be found <a href="http://code.google.com/p/tarantino/wiki/DatabaseChangeManagement">here</a>. One of the outcome of this project is a <strong>custom</strong> <strong>nant</strong> task called <strong>manageSqlDatabase</strong>. We will use nant and this custom task to manage our (sample) database.</p> <p>You need the following files to be able to use the custom task</p> <ul> <li><a><font color="#000000">Tarantino.CommonsCore.dll </font></a> <li><a><font color="#000000">Tarantino.DatabaseManager.Tasks.dll </font></a> <li><a><font color="#000000">Microsoft.SqlServer.BatchParser.dll </font></a> <li><a><font color="#000000">Microsoft.SqlServer.ConnectionInfo.dll </font></a> <li><a><font color="#000000">Microsoft.SqlServer.Smo.dll </font></a></li></ul> <p>To get the files for your own solution either download the <a href="https://hibernatingrhinos.googlecode.com/svn/trunk/ManageSqlDatabase">sample solution</a> accompanying this post or download it directly from the <strong>Tarantino</strong> project which you can find <a href="http://code.google.com/p/tarantino/downloads/list">here</a>.</p> <h2>The build file</h2> <p>The general format of the <strong>custom nant</strong> task is</p><pre><span style="color: #0000ff">&lt;</span><span style="color: #800000">manageSqlDatabase</span>
  <span style="color: #ff0000">scriptDirectory</span>=<span style="color: #0000ff">"${database.script.directory}"</span>
  <span style="color: #ff0000">action</span>=<span style="color: #0000ff">"${action}"</span>
  <span style="color: #ff0000">server</span>=<span style="color: #0000ff">"${database.server}"</span>
  <span style="color: #ff0000">integratedAuthentication</span>=<span style="color: #0000ff">"${database.integrated}"</span>
  <span style="color: #ff0000">database</span>=<span style="color: #0000ff">"${database.name}"</span>
  <span style="color: #ff0000">username</span>=<span style="color: #0000ff">"${database.username}"</span>
  <span style="color: #ff0000">password</span>=<span style="color: #0000ff">"${database.password}"</span>
<span style="color: #0000ff">/&gt;</span></pre>
<p>The <strong>sriptDirectory</strong> contains the path to the files which contain the schema creation and/or schema update statements.</p>
<p>The possible <strong>actions</strong> are</p>
<ul>
<li>dropDatabase 
<li>createDatabase 
<li>rebuildDatabase 
<li>updateDatabase </li></ul>
<p>The <strong>server</strong> parameter must contain the name of the SQL Server (e.g. "<strong>localhost/SQLEXPRESS</strong>").</p>
<p>The parameter <strong>IntegratedAuthentication </strong>can be either <strong>true</strong> or <strong>false</strong>.</p>
<p>The parameter <strong>database</strong> contais the name of the database to re-create or update (e.g. "<strong>SampleDatabase</strong>")</p>
<p>The parameters <strong>username</strong> and <strong>password</strong> are only needed if <strong>IntegratedAuthentication</strong> is set to <strong>false</strong>.</p>
<p>A typical create database scenario could be as shown below</p><pre><span style="color: #0000ff">&lt;</span><span style="color: #800000">manageSqlDatabase</span>
  <span style="color: #ff0000">scriptDirectory</span>=<span style="color: #0000ff">"src\database"</span>
  <span style="color: #ff0000">action</span>=<span style="color: #0000ff">"createDatabase"</span>
  <span style="color: #ff0000">server</span>=<span style="color: #0000ff">"localhost"</span>
  <span style="color: #ff0000">integratedAuthentication</span>=<span style="color: #0000ff">"true"</span>
  <span style="color: #ff0000">database</span>=<span style="color: #0000ff">"SampleDatabase"</span>
<span style="color: #0000ff">/&gt;</span></pre>
<p>Let's not construct a complete build file for nant which includes the task of dropping and re-creating a database and the creation of the database schema. We create a new empty file called default.build and enter the following XML fragments.</p>
<div>
<div style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none"><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none"><span style="color: #0000ff">&lt;?</span><span style="color: #800000">xml</span> <span style="color: #ff0000">version</span><span style="color: #0000ff">="1.0"</span> <span style="color: #ff0000">encoding</span><span style="color: #0000ff">="utf-8"</span>?<span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none"><span style="color: #0000ff">&lt;</span><span style="color: #800000">project</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="DemoSolution"</span> <span style="color: #ff0000">default</span><span style="color: #0000ff">="builddatabase"</span> </pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">         <span style="color: #ff0000">xmlns</span><span style="color: #0000ff">="http://nant.sf.net/release/0.85/nant.xsd"</span><span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">property</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="solution.dir"</span> <span style="color: #ff0000">value</span><span style="color: #0000ff">="src"</span> <span style="color: #0000ff">/&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">property</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="database.script.directory"</span> <span style="color: #ff0000">value</span><span style="color: #0000ff">="${solution.dir}/Database"</span><span style="color: #0000ff">/&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">property</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="database.server"</span> <span style="color: #ff0000">value</span><span style="color: #0000ff">="localhost"</span><span style="color: #0000ff">/&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">property</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="database.name"</span> <span style="color: #ff0000">value</span><span style="color: #0000ff">="${project::get-name()}"</span><span style="color: #0000ff">/&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">&nbsp;</pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">target</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="builddatabase"</span> <span style="color: #ff0000">depends</span><span style="color: #0000ff">="dropDatabase, createDatabase"</span> <span style="color: #0000ff">/&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">    </pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">target</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="dropDatabase"</span><span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">  <span style="color: #0000ff">&lt;/</span><span style="color: #800000">target</span><span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">    </pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">target</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="createDatabase"</span><span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">  <span style="color: #0000ff">&lt;/</span><span style="color: #800000">target</span><span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">  </pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none"><span style="color: #0000ff">&lt;/</span><span style="color: #800000">project</span><span style="color: #0000ff">&gt;</span></pre></div></div>
<p>In this file we define a new nant project called <strong>DemoSolution</strong>. The default target that is executed is <strong>builddatabase</strong>. Then we define some properties for reference in our project (if you are not fluent in nant syntax please consult the online documentation <a href="http://nant.sourceforge.net/release/latest/help/index.html">here</a>.)</p>
<p>The <strong>builddatabase</strong> target does nothing else than trigger the targets <strong>dropDatabase</strong> and <strong>createDatabase,</strong> that is if the database already exists then it is dropped and then re-created. Finally the database schema is created. But wait, those two targets are empty at the moment and will do absolutely nothing at the moment.</p>
<p>Let's now add this helper target to the build file - we want to avoid duplication don't we?</p>
<div>
<div style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none"><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none"><span style="color: #0000ff">&lt;</span><span style="color: #800000">target</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="manageSqlDatabase"</span><span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">manageSqlDatabase</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">    <span style="color: #ff0000">scriptDirectory</span><span style="color: #0000ff">="${database.script.directory}"</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">    <span style="color: #ff0000">action</span><span style="color: #0000ff">="${action}"</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">    <span style="color: #ff0000">server</span><span style="color: #0000ff">="${database.server}"</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">    <span style="color: #ff0000">integratedAuthentication</span><span style="color: #0000ff">="true"</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">    <span style="color: #ff0000">database</span><span style="color: #0000ff">="${database.name}"</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">  <span style="color: #0000ff">/&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">&nbsp;</pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">if</span> <span style="color: #ff0000">test</span><span style="color: #0000ff">="${action != 'Drop'}"</span><span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">echo</span> <span style="color: #ff0000">message</span><span style="color: #0000ff">="Current Database Version: ${usdDatabaseVersion}"</span> <span style="color: #0000ff">/&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">  <span style="color: #0000ff">&lt;/</span><span style="color: #800000">if</span><span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">&nbsp;</pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none"><span style="color: #0000ff">&lt;/</span><span style="color: #800000">target</span><span style="color: #0000ff">&gt;</span></pre></div></div>
<p>it will be called by the <strong>dropDatabase</strong> and <strong>createDatabase</strong> targets where each provides another action parameter. Note that the <strong>usdDatabaseVersion</strong> parameter is generated by the <strong>manageSqlDatabase</strong> custom task.</p>
<p>Now we complete the <strong>dropDatabase</strong> and <strong>createDatabase</strong> targets as follows</p>
<div>
<div style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none"><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none"><span style="color: #0000ff">&lt;</span><span style="color: #800000">target</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="dropDatabase"</span><span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">property</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="action"</span> <span style="color: #ff0000">value</span><span style="color: #0000ff">="Drop"</span> <span style="color: #0000ff">/&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">call</span> <span style="color: #ff0000">target</span><span style="color: #0000ff">="manageSqlDatabase"</span> <span style="color: #ff0000">failonerror</span><span style="color: #0000ff">="false"</span><span style="color: #0000ff">/&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none"><span style="color: #0000ff">&lt;/</span><span style="color: #800000">target</span><span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">&nbsp;</pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none"><span style="color: #0000ff">&lt;</span><span style="color: #800000">target</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="createDatabase"</span><span style="color: #0000ff">&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">property</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">="action"</span> <span style="color: #ff0000">value</span><span style="color: #0000ff">="Create"</span> <span style="color: #0000ff">/&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">call</span> <span style="color: #ff0000">target</span><span style="color: #0000ff">="manageSqlDatabase"</span> <span style="color: #0000ff">/&gt;</span></pre><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: white; border-bottom-style: none"><span style="color: #0000ff">&lt;/</span><span style="color: #800000">target</span><span style="color: #0000ff">&gt;</span></pre></div></div>
<p>that is we use the standard call task of nunit to trigger the custom task. Note that the <strong>dropDatabase</strong> target calls the custom task with <strong>failonerror</strong> set to <strong>false</strong> (default is <strong>true</strong>). It is possible that the database does not yet exist. In this case the build should just continue.</p>
<h2>The script files</h2>
<p>One of the main parts in the automation process is still missing. It's the SQL script files which generate and/or update the database schema. These files have to be valid SQL scripts (you should be able to run these scripts without errors in e.g. a query session in "<strong>SQL Server Management Studio")</strong>. The scripts can contain DDL and DML statements. They have to be sequentially numbered, e.g.</p>
<ul>
<li>0001_CreateBaseSchema.sql 
<li>0002_AddProductAndCategory.sql 
<li>0003_AddIndexes.sql 
<li>0004_InitialDataLoad.sql 
<li>etc. </li></ul>
<p>You can freely choose any name after the underscore. The <strong>manageSqlDatabase</strong> nant task will apply the scripts sequentially starting with the lowest number and ending with the highest number. When creating the database the <strong>manageSqlDatabase</strong> nant task will add a special table to the database which keeps track of which scripts have been applied.</p>
<h2>How to create the script files</h2>
<p>The initial schema generation script I normally generate by using NHibernate's schema export utility. See <a href="http://blogs.hibernatingrhinos.com/nhibernate/archive/2008/04/28/create-and-update-database-schema.aspx">this post</a> for an in depth discussion. Alternatively you can also use the script database objects task of "<strong>SQL Server Management Studio</strong>". For any further modifications of the schema (especially if the first version is already in production) I use a product like <strong>Redgate's </strong><a href="http://www.red-gate.com/products/SQL_Compare/index.htm"><strong>SQL Compare</strong></a> or the same product from <a href="http://www.apexsql.com/sql_tools_diff.asp">Apex</a> to generate the alter scripts.</p>
<h2>Execute the build</h2>
<p>We can now execute the build by invoking the following command</p>
<p><font face="Courier New" color="#0080ff">bin\nant\nant.exe -buildfile:default.build</font></p>
<p>we can write a batch file <strong>builddatabase.bat</strong> to further automate the process. The content of the batch file might be as follows</p>
<p><font face="Courier New" color="#0080ff">bin\nant\nant.exe -buildfile:default.build <br>pause</font></p>
<h2>Sample Code</h2>
<p>You can download a little sample from <a href="https://hibernatingrhinos.googlecode.com/svn/trunk/ManageSqlDatabase">here</a>. You need to have an SQL Server available. A local installation of SQL Server Express Edition is enough. Please adjust the properties <strong>database.server</strong> and <strong>database.name</strong> in the file <strong>default.build</strong> according your needs. Double click the file <strong>builddatabase.bat</strong> to test the creation of the database and the database schema.</p>
<p>Enjoy! </p>
<p><a href="http://www.nhforge.org/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/Blog-Signature-Gabriel_5F00_2.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="21" alt="Blog Signature Gabriel" src="/images/posts/2008/09/06/Blog-Signature-Gabriel_5F00_thumb.png" width="244" border="0"></a></p>
