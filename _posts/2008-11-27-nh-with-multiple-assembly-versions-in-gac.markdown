---
layout: post
title: "NH with Multiple Assembly versions in GAC"
date: 2008-11-27 15:32:00 +1300
comments: true
published: true
categories: ["blogs", "nhibernate", "archive"]
tags: ["NHibernate", "GAC"]
redirect_from: ["/blogs/nhibernate/archive/2008/11/27/nh-with-multiple-assembly-versions-in-gac.aspx"]
author: fabiomaulo
gravatar: cd6db202ce94ed7e5f1fde30e702dc7f
---
{% include imported_disclaimer.html %}
<p>I know that the title have something strange because NH don&rsquo;t have nothing to do with GAC, but in NH-JIRA we have an issue with this title: &ldquo;NHibernate does not support multiple versions of the same assembly for entity mapping&rdquo;</p>
<p>Perhaps I don&rsquo;t understand what that issue mean; I can&rsquo;t understand what mean work we two mappings versions of the same entity&hellip; mean it work with two tables versions in the same DB at the same time ?</p>
<p>If the problem is not the mapping but the class implementation, NH are using, this is the solution.</p>
<p>Domain <strong>version 1.0.0.0</strong></p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">Person<br /></span>{<br />  <span style="color: blue">public virtual int </span>Id { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }<br />  <span style="color: blue">public virtual string </span>FirstName { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }<br />  <span style="color: blue">public virtual string </span>LastName { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }<br /><br />  <span style="color: blue">public virtual string </span>FullName<br />  {<br />      <span style="color: blue">get </span>{ <span style="color: blue">return string</span>.Concat(FirstName, <span style="color: #a31515">"-"</span>, LastName); }<br />  }<br />}</pre>
<p>The mapping is:</p>
<pre class="code"><span style="color: blue">&lt;</span><span style="color: #a31515">hibernate-mapping </span><span style="color: red">xmlns</span><span style="color: blue">=</span>"<span style="color: blue">urn:nhibernate-mapping-2.2</span>"<br />                 <span style="color: red">assembly</span><span style="color: blue">=</span>"<span style="color: blue">Company.Domain</span>"<br />                 <span style="color: red">namespace</span><span style="color: blue">=</span>"<span style="color: blue">Company.Domain</span>"<span style="color: blue">&gt;<br />  &lt;</span><span style="color: #a31515">class </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">Person</span>"<span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">id </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">Id</span>"<span style="color: blue">&gt;<br />          &lt;</span><span style="color: #a31515">generator </span><span style="color: red">class</span><span style="color: blue">=</span>"<span style="color: blue">native</span>"<span style="color: blue">/&gt;<br />      &lt;/</span><span style="color: #a31515">id</span><span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">FirstName</span>"<span style="color: blue">/&gt;<br />      &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">LastName</span>"<span style="color: blue">/&gt;<br />  &lt;/</span><span style="color: #a31515">class</span><span style="color: blue">&gt;<br />&lt;/</span><span style="color: #a31515">hibernate-mapping</span><span style="color: blue">&gt;<br /></span></pre>
<p><span style="font-weight: bold">Note:</span> In the mapping I don&rsquo;t write anything about the version of the assembly.</p>
<p>Sign, and compile the domain, and add it to the GAC.</p>
<p><a href="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/GACAdded_5F00_73C2338C.png"><img border="0" width="644" src="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/GACAdded_5F00_thumb_5F00_21435350.png" alt="GACAdded" height="29" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" title="GACAdded" /></a> </p>
<p>Domain <strong>version 1.1.0.0</strong></p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">Person<br /></span>{<br />  <span style="color: blue">public virtual int </span>Id { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }<br />  <span style="color: blue">public virtual string </span>FirstName { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }<br />  <span style="color: blue">public virtual string </span>LastName { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }<br /><br />  <span style="color: blue">public virtual string </span>FullName<br />  {<br />      <span style="color: blue">get </span>{ <span style="color: blue">return string</span>.Concat(LastName, <span style="color: #a31515">"*"</span>, FirstName); }<br />  }<br />}</pre>
<p>As you can see there is a different implementation of the property FullName.</p>
<p>Compile and add the new version to the GAC.</p>
<p><a href="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/GACAddedBoth_5F00_439AE8C9.png"><img border="0" width="644" src="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/GACAddedBoth_5F00_thumb_5F00_53A9B780.png" alt="GACAddedBoth" height="37" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" title="GACAddedBoth" /></a> </p>
<h3>The Test</h3>
<p>Without make a completely automated test&hellip;</p>
<pre class="code">[<span style="color: #2b91af">Test</span>]<br /><span style="color: blue">public void </span>SomebodySaidIsABug()<br />{<br />  <span style="color: blue">var </span>version = <span style="color: blue">typeof </span>(<span style="color: #2b91af">Person</span>).Assembly.GetName().Version.ToString();<br />  <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">"Running version {0}"</span>, version);<br /><br />  <span style="color: blue">object </span>savedId;<br />  <span style="color: blue">using </span>(<span style="color: #2b91af">ISession </span>s = sessions.OpenSession())<br />  <span style="color: blue">using </span>(<span style="color: #2b91af">ITransaction </span>tx = s.BeginTransaction())<br />  {<br />      <span style="color: blue">var </span>a = <span style="color: blue">new </span><span style="color: #2b91af">Person </span>{FirstName = <span style="color: #a31515">"Pasqual"</span>, LastName = <span style="color: #a31515">"Angulo"</span>};<br />      savedId = s.Save(a);<br />      tx.Commit();<br />  }<br /><br />  <span style="color: blue">using </span>(<span style="color: #2b91af">ISession </span>s = sessions.OpenSession())<br />  <span style="color: blue">using </span>(<span style="color: #2b91af">ITransaction </span>tx = s.BeginTransaction())<br />  {<br />      <span style="color: blue">var </span>a = s.Get&lt;<span style="color: #2b91af">Person</span>&gt;(savedId);<br />      <span style="color: blue">if</span>(version == <span style="color: #a31515">"1.0.0.0"</span>)<br />          <span style="color: #2b91af">Assert</span>.That(a.FullName, <span style="color: #2b91af">Is</span>.EqualTo(<span style="color: #a31515">"Pasqual-Angulo"</span>));<br />      <span style="color: blue">else<br />          </span><span style="color: #2b91af">Assert</span>.That(a.FullName, <span style="color: #2b91af">Is</span>.EqualTo(<span style="color: #a31515">"Angulo*Pasqual"</span>));<br />      tx.Commit();<br />  }<br /><br />  <span style="color: blue">using </span>(<span style="color: #2b91af">ISession </span>s = sessions.OpenSession())<br />  <span style="color: blue">using </span>(<span style="color: #2b91af">ITransaction </span>tx = s.BeginTransaction())<br />  {<br />      s.Delete(<span style="color: #a31515">"from Person"</span>);<br />      tx.Commit();<br />  }<br />}</pre>
<p>I&rsquo;m showing the loaded version used in tests (that, in this, case represent the assembly with the responsibility of DataAccess) and changing the expected value of FullName according with the assembly version.</p>
<p>The assembly referenced by the test project, at design time, is not important.</p>
<p>The App.config of the test is:</p>
<pre class="code"><span style="color: blue">&lt;</span><span style="color: #a31515">configSections</span><span style="color: blue">&gt;<br />  &lt;</span><span style="color: #a31515">section </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">hibernate-configuration</span>" <span style="color: red">type</span><span style="color: blue">=</span>"<span style="color: blue">NHibernate.Cfg.ConfigurationSectionHandler, NHibernate</span>"<span style="color: blue">/&gt;<br />&lt;/</span><span style="color: #a31515">configSections</span><span style="color: blue">&gt;<br /><br />&lt;</span><span style="color: #a31515">hibernate-configuration </span><span style="color: red">xmlns</span><span style="color: blue">=</span>"<span style="color: blue">urn:nhibernate-configuration-2.2</span>"<span style="color: blue">&gt;<br />  &lt;</span><span style="color: #a31515">session-factory </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">Company</span>"<span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">connection.provider</span>"<span style="color: blue">&gt;</span>NHibernate.Connection.DriverConnectionProvider<span style="color: blue">&lt;/</span><span style="color: #a31515">property</span><span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">connection.driver_class</span>"<span style="color: blue">&gt;</span>NHibernate.Driver.SqlClientDriver<span style="color: blue">&lt;/</span><span style="color: #a31515">property</span><span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">dialect</span>"<span style="color: blue">&gt;</span>NHibernate.Dialect.MsSql2005Dialect<span style="color: blue">&lt;/</span><span style="color: #a31515">property</span><span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">connection.connection_string</span>"<span style="color: blue">&gt;<br />          </span>Data Source=localhost\SQLEXPRESS;Initial Catalog=BlogSpot;Integrated Security=True<br />      <span style="color: blue">&lt;/</span><span style="color: #a31515">property</span><span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">show_sql</span>"<span style="color: blue">&gt;</span>false<span style="color: blue">&lt;/</span><span style="color: #a31515">property</span><span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">use_outer_join</span>"<span style="color: blue">&gt;</span>true<span style="color: blue">&lt;/</span><span style="color: #a31515">property</span><span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">query.substitutions</span>"<span style="color: blue">&gt;</span>true 1, false 0, yes 'Y', no 'N'<span style="color: blue">&lt;/</span><span style="color: #a31515">property</span><span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">command_timeout</span>"<span style="color: blue">&gt;</span>60<span style="color: blue">&lt;/</span><span style="color: #a31515">property</span><span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">property </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">proxyfactory.factory_class</span>"<span style="color: blue">&gt;</span>NHibernate.ByteCode.LinFu.ProxyFactoryFactory, NHibernate.ByteCode.LinFu<span style="color: blue">&lt;/</span><span style="color: #a31515">property</span><span style="color: blue">&gt;<br />    <br />      &lt;</span><span style="color: #a31515">mapping </span><span style="color: red">assembly</span><span style="color: blue">=</span>"<span style="color: blue">Company.Domain</span>"<span style="color: blue">/&gt;<br />    <br />  &lt;/</span><span style="color: #a31515">session-factory</span><span style="color: blue">&gt;<br />&lt;/</span><span style="color: #a31515">hibernate-configuration</span><span style="color: blue">&gt;</span></pre>
<pre class="code"><span style="color: blue"><span style="color: #000000; font-family: trebuchet ms">I&rsquo;m loading the assembly with all mappings, trough the session-factory configuration, another time without specify the assembly strong name.</span></span></pre>
<pre class="code"><span style="color: blue"><span style="color: #000000; font-family: trebuchet ms">Compile the test project and close VisualStudio. Now go to the output folder (bin/Debug) and delete the Company.Domain.dll file. Then open NUnit.Gui.</span></span></pre>
<pre class="code"><span style="color: blue"><span style="color: #000000; font-family: trebuchet ms">The situation at this point is:</span></span></pre>
<pre class="code"><ul><li><span style="font-family: 'Trebuchet MS'"><span style="font-size: medium">Two version of Company.Domain.dll in the GAC.</span></span><span style="font-size: medium"><br /></span></li><li><span style="font-family: 'Trebuchet MS'"><span style="font-size: medium">Visual Studio Closed</span></span><span style="font-size: medium"><br /></span></li><li><span style="font-family: 'Trebuchet MS'"><span style="font-size: medium">The test compiled and the Company.Domain.dll removed</span></span><span style="font-size: medium"><br /></span></li><li><span style="font-family: 'Trebuchet MS'"><span style="font-size: medium">NUnit.GUI opened</span></span><br /></li></ul></pre>
<pre class="code"><span style="color: blue"><span style="color: #000000; font-family: trebuchet ms">Because I'm not using the strongly name of <span style="font-style: italic">Company.Domain.dll</span>, running the test what I expect is that it fail</span></span></pre>
<pre class="code"><span style="color: blue"><span style="color: #000000; font-family: trebuchet ms"><a href="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/NunitNoOk0_5F00_20D9B10C.png"><img border="0" width="642" src="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/NunitNoOk0_5F00_thumb_5F00_34892B51.png" alt="NunitNoOk0" height="162" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" title="NunitNoOk0" /></a>  </span></span></pre>
<pre class="code"><span style="color: blue"><span style="color: #000000; font-family: trebuchet ms">Perfect!! Assembly not found. Now I can start to play with the compiled configuration file (<span style="font-style: italic"><span style="font-weight: bold">DiffAssemblyVersion.dll.config</span></span>) using the NotePad.</span></span></pre>
<pre class="code">    <span style="color: blue">&lt;</span><span style="color: #a31515">runtime</span><span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">assemblyBinding </span><span style="color: red">xmlns</span><span style="color: blue">=</span>"<span style="color: blue">urn:schemas-microsoft-com:asm.v1</span>" <span style="color: red">applies-to</span><span style="color: blue">=</span>"<span style="color: blue">v2.0.50727</span>"<span style="color: blue">&gt;<br />          &lt;</span><span style="color: #a31515">qualifyAssembly </span><span style="color: red">partialName</span><span style="color: blue">=</span>"<span style="color: blue">Company.Domain</span>"<br />              <span style="color: red">fullName</span><span style="color: blue">=</span>"<span style="color: blue">Company.Domain, Version=1.0.0.0, Culture=neutral, PublicKeyToken=5c41dce254553643</span>" <span style="color: blue">/&gt;<br />      &lt;/</span><span style="color: #a31515">assemblyBinding</span><span style="color: blue">&gt;<br />  &lt;/</span><span style="color: #a31515">runtime</span><span style="color: blue">&gt;<br /></span></pre>
<p>
<a href="http://11011.net/software/vspaste"></a></p>
<p>Now, if I reload the assembly in NUnit.GUI, the assembly will be loaded from GAC.</p>
<p><a href="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/NunitOk10_5F00_63DD318C.png"><img border="0" width="644" src="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/NunitOk10_5F00_thumb_5F00_7A32D6D1.png" alt="NunitOk10" height="114" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" title="NunitOk10" /></a> </p>
<p>Now I want run the test but using the 1.1.0.0 version. Using NotePad again the new config is:</p>
<pre class="code"><span style="color: blue">&lt;</span><span style="color: #a31515">runtime</span><span style="color: blue">&gt;<br />  &lt;</span><span style="color: #a31515">assemblyBinding </span><span style="color: red">xmlns</span><span style="color: blue">=</span>"<span style="color: blue">urn:schemas-microsoft-com:asm.v1</span>" <span style="color: red">applies-to</span><span style="color: blue">=</span>"<span style="color: blue">v2.0.50727</span>"<span style="color: blue">&gt;<br />      &lt;</span><span style="color: #a31515">qualifyAssembly </span><span style="color: red">partialName</span><span style="color: blue">=</span>"<span style="color: blue">Company.Domain</span>"<br />          <span style="color: red">fullName</span><span style="color: blue">=</span>"<span style="color: blue">Company.Domain, Version=1.0.0.0, Culture=neutral, PublicKeyToken=5c41dce254553643</span>" <span style="color: blue">/&gt;<br />      &lt;</span><span style="color: #a31515">dependentAssembly</span><span style="color: blue">&gt;<br />          &lt;</span><span style="color: #a31515">assemblyIdentity </span><span style="color: red">name</span><span style="color: blue">=</span>"<span style="color: blue">Company.Domain</span>"<br />                            <span style="color: red">publicKeyToken</span><span style="color: blue">=</span>"<span style="color: blue">5c41dce254553643</span>"<span style="color: blue">/&gt;<br />          &lt;</span><span style="color: #a31515">bindingRedirect </span><span style="color: red">oldVersion</span><span style="color: blue">=</span>"<span style="color: blue">1.0.0.0</span>"<br />                           <span style="color: red">newVersion</span><span style="color: blue">=</span>"<span style="color: blue">1.1.0.0</span>"<span style="color: blue">/&gt;<br />      &lt;/</span><span style="color: #a31515">dependentAssembly</span><span style="color: blue">&gt;<br />  &lt;/</span><span style="color: #a31515">assemblyBinding</span><span style="color: blue">&gt;<br />&lt;/</span><span style="color: #a31515">runtime</span><span style="color: blue">&gt;</span></pre>
<p>Reload the assembly in NUnit.GUI and re-run it:</p>
<p><a href="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/NunitOk11_5F00_4528D852.png"><img border="0" width="644" src="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate/NunitOk11_5F00_thumb_5F00_34B06757.png" alt="NunitOk11" height="102" style="border-top-width: 0px; display: inline; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" title="NunitOk11" /></a> </p>
<p>Work done.</p>
<p>Code available <a href="http://code.google.com/p/unhaddins/source/browse/#svn/HunabKu/src/DiffAssemblyVersion">here</a>.</p>
