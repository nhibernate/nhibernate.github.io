

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head><meta http-equiv="X-UA-Compatible" content="IE=7" /><meta name="robots" content="index,follow" />
<meta name="description" content="The official NHibernate community site. Download NHibernate. Read blogs. Contribute to the NHibernate Wiki. Find reference documentation." />
<meta name="keywords" content="NHibernate, NHibernate Contrib, community, Burrow, Downloads" />
<meta name="GENERATOR" content="CommunityServer 2008.5 SP1 (Build: 31106.3070)" />
<link rel="shortcut icon" type="image/ico" href="../../../../favicon.ico" />
<link rel="alternate" type="application/rss+xml" title="Simple audit metadata and logical deletion of business entities (RSS 2.0)" href="../rss.aspx"  />
<link rel="alternate" type="application/rss+xml" title="How to (RSS 2.0)" href="http://nhforge.org/wikis/howtonh/rss.aspx"  />
<link rel="alternate" type="application/rss+xml" title="Raul Carlomagno&#39;s Announcements (RSS 2.0)" href="../../../../members/rcarlomagno/announcements/rss.aspx"  />
<link rel="alternate" type="application/rss+xml" title="Raul Carlomagno&#39;s Comments (RSS 2.0)" href="../../../../members/rcarlomagno/comments/rss.aspx"  />
<link rel="alternate" type="application/rss+xml" title="Raul Carlomagno&#39;s Activities (RSS 2.0)" href="../../../../members/rcarlomagno/activities/rss.aspx"  />
<link rel="alternate" type="application/rss+xml" title="Raul Carlomagno&#39;s Friends Activity (RSS 2.0)" href="../../../../members/rcarlomagno/activities/friendrss.aspx"  />

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <style type="text/css"> body { font-size: 84%; } </style>
        <link rel="stylesheet" href="../../../../themes/hawaii/style/Common.css" type="text/css" media="screen,print" />
        <link rel="stylesheet" href="../../../../themes/hawaii/style/common_print.css" type="text/css" media="print" />
        
    
    <link rel="stylesheet" href="../../../../Themes/hawaii/style/wiki.css" type="text/css" media="screen,print" />
	

        <link rel="stylesheet" href="../../../../themes/hawaii/style/DynamicStyle.aspx.css" type="text/css" media="screen" />
        <!--[if lte IE 6]>
            <link rel="stylesheet" href="/themes/hawaii/style/ie6.css" type="text/css" media="screen" />
        <![endif]-->
    <meta name="google-site-verification" content="u9qihpHbzSFdf2ypCUvCQrj9IJkANGzorC8zMk0859M" />
<title>
	Simple audit metadata and logical deletion of business entities: Revision #3 - NHibernate Forge
</title></head>
	<body>
		<form name="aspnetForm" method="post" action="3.aspx.html" id="aspnetForm">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwULLTE2ODYxODYyODBkGAEFHl9fQ29udHJvbHNSZXF1aXJlUG9zdEJhY2tLZXlfXxYBBTBjdGwwMCRjdGwwMCRzciRzciRjdGwwMCRjdGwwMCRUaXRsZUJhclNlYXJjaFRleHRS2dku67jB2SYXikwjMUBFR1YWDw==" />
</div>


<script src="../../../../WebResource.axd%3Fd=0gbcOAOlbWsHyCtP1tLKZQbpxrEkhg31E8L04T1x-hMLrsMonvmUNQvxBohSywWHueFgWT841lW9e5k7Gp2DbPsOLeN3Sv3SB7czfVSlQGxYOHnJcLlKfh3v9vlcjJ9ggvps0fjahw73J3SVYQmGvS0rXng1&amp;t=634395149500000000" type="text/javascript"></script>
<script src="../../../../WebResource.axd%3Fd=qXX_qxw7Y60qjc1NsxHnuIWUCy9JxjEUKLrY5KEQyuYhKzv3UmRPH805gTXU5edfSsLl7PHTIDuZbzGOp5UYEWeQ6anyqFa-m5TiNnZiD5MOrgiKWAZBgPyJ267gdCbk0_TpK2BaAhLvEgyM28dt9SYQ2UM1&amp;t=634395149500000000" type="text/javascript"></script>
<script src="../../../../WebResource.axd%3Fd=c5kkseX-7hUDg441H_iVoy5ws7YKvwS4KliHEKHuRl5UdJkUU5Jbdf2sxzCcbfyn6sqe17DzqhSTfAyV8nyJKMHhScl2IzjSz37RVYryN9Omis3K0NCj_OJ4fHZH3n9_IPBlNLVyYL45kjJL_zhydrkKTi3FfxaImDeS_1JZIO7o9iFs0&amp;t=634395149500000000" type="text/javascript"></script>
						

			

		    
		        <div id="CommonHeader">
		            <div class="Common">
		                <div id="CommonHeaderTitleArea">
		                    <table cellpadding="0" cellspacing="0" border="0"><tr valign="middle">
		                        <td><div style="margin-right: 10px;"><img src="../../../../cfs-file.ashx/__key/CommunityServer.Components.SiteFiles/logos/LogoNH.gif" alt="" style="border-width:0px;" /></div></td>
		                        <td>
		                            <div class="CommonHeaderTitle">NHibernate Forge</div>
		                            <div class="CommonHeaderTitleDescription">The official new home for the NHibernate for .NET community</div>
		                        </td>
		                    </tr></table>
		                </div>
		                <div id="CommonHeaderUserArea">
		                    <table cellpadding="0" cellspacing="0" border="0"><tr valign="top"><td>
                                <div id="CommonHeaderUserContent">
                                    <div id="CommonHeaderUserWelcome">
                                        
        <a href="http://nhforge.org/login.aspx?ReturnUrl=%2fwikis%2fhowtonh%2fsimple-audit-metadata-and-logical-deletion-of-business-entities%2frevision%2f3.aspx">Sign in </a>
         | <a href="../../../../user/CreateUser.aspx%3FReturnUrl=.html">Join</a>
        | <a href="http://dev.communityserver.com/r.ashx?K&amp;siteurl=wikis.wiki_Page_ViewRevision">Help</a>
     


                                    </div>
                                </div>
                            </td></tr></table>
                        </div>
                    </div>
                </div>
                <div id="CommonNavigation">
                    <div class="Common"><div class="Inner">
                        <ul>
                                
                                <li><a href="../../../../index.html">Home</a></li>
                            
                                
                                <li><a href="../../../../blogs/nhibernate.html">Blog</a></li>
                            
                                <li><a class="Selected" href="../../../index.html">Wikis</a></li>
                                
                            
                                
                                <li><a href="../../../../groups/index.html">Groups</a></li>
                            
                                
                                <li><a href="../../../../doc/nh/en/index.html">Reference</a></li>
                            
                                
                                <li><a href="http://nhibernate.jira.com">Issue tracker</a></li>
                            
                                
                                <li><a href="https://github.com/nhibernate/nhibernate-core">Source Code</a></li>
                            </ul>
                        <div style="clear: both;"></div>
                     </div></div>
                </div>
                
                        <div id="CommonNavigation2">
                            <div class="Common"><div class="Inner">
                                <ul>
                    
                        
                        <li><a href="../../../general/default.aspx.html">General</a></li>
                    
                        <li><a class="Selected" href="../../default.aspx.html">How to</a></li>
                        
                    
                        
                        <li><a href="../../../patternsandpractices/default.aspx.html">Patterns&Practices</a></li>
                    
                                </ul>
                            </div></div>
                        </div>
                    
                <div id="CommonNavigationShadow">
                    
    
    <div class="CommonBreadCrumbArea"><div class="Common">
        <a href="../../../index.html">Wikis</a>
        &raquo;
        <a href="../../default.aspx.html">How to</a>
        &raquo;
        <a href="../../simple-audit-metadata-and-logical-deletion-of-business-entities.aspx.html">Simple audit metadata and logical deletion of business entities</a>
        &raquo;
        Revision #3
    </div></div>


                </div>
		    
                        
            <div class="Common">
            
                
            
                <div id="CommonSearch">
                    
    
        
                <div class="CommonSearchArea">
                    <div class="CommonSearchRoundTop"><div class="r1"></div><div class="r2"></div><div class="r3"></div><div class="r4"></div></div>
                    <div class="CommonSearchContent"><div class="CommonSearchContentInner">
                        <input name="ctl00$ctl00$sr$sr$ctl00$ctl00$TitleBarSearchText" type="text" maxlength="64" size="15" id="ctl00_ctl00_sr_sr_ctl00_ctl00_TitleBarSearchText" onclick="if(this.defaultValue==this.value) this.value='';" onblur="if(this.value=='') this.value=this.defaultValue;" onkeydown="return KeyDownHandlerctl00_ctl00_sr_sr_ctl00_ctl00_TitleBarSearchButton(event);" /><input type="submit" name="ctl00$ctl00$sr$sr$ctl00$ctl00$TitleBarSearchButton" value="Â " id="ctl00_ctl00_sr_sr_ctl00_ctl00_TitleBarSearchButton" class="CommonSearchButton" />
                    </div></div>
                    <div class="CommonSearchRoundBottom"><div class="r1"></div><div class="r2"></div><div class="r3"></div><div class="r4"></div></div>
                </div>
            
    

                </div>
                <div id="CommonTitle">
                    
    
    <h1 class="CommonTitle">Simple audit metadata and logical deletion of business entities: 
            Revision #3
        </h1>


                </div>
                <div style="clear: both;"></div>
			    <div id="CommonSidebarRight">
			        
    
	<div class="CommonSidebar">
	    
	    
	        
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Shortcuts</h4>
	                    <div class="CommonContentBoxContent">
	            <ul class='CommonSidebarList'><li><a href="../../default.aspx.html">Home</a></li><li><a href="../rss.aspx">RSS feed for page</a></li></ul>
				        </div>
				        
			        </div>
	            
	    
	        
	    
	        
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Wiki Page Hierarchy</h4>
	                    <div class="CommonContentBoxContent">
	            <div><ul class="CommonHierarchicalList"><li><a href="../../mapping-a-view-and-schema-export-workaround.aspx.html">Mapping a view and Schema Export Workaround</a></li><li><a href="../../lazy-loading-eager-loading.aspx.html">Lazy loading - eager loading</a></li><li><a href="../../configure-log4net-for-use-with-nhibernate.aspx.html">Configure Log4Net for use with NHibernate</a></li><li><a href="../../get-unique-results-from-joined-queries.aspx.html">Get unique results from joined queries</a></li><li><a href="3.aspx.html#" onclick="ctl00_ctl00_rcr_rcr_ctl00_ctl02_ctl00_ctl01_ctl01._expand(30, this); return false;"><img src="../../../../WebResource.axd%3Fd=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000" alt="+" style="border-width: 0;" /></a><a href="../../your-first-nhibernate-based-application.aspx.html">Your first NHibernate based application</a></li><li><a href="../../run-in-medium-trust.aspx.html">Run in Medium Trust</a></li><li><a href="../../pre-generate-lazy-loading-proxies.aspx.html">Pre-Generate Lazy Loading Proxies</a></li><li><a href="3.aspx.html#" onclick="ctl00_ctl00_rcr_rcr_ctl00_ctl02_ctl00_ctl01_ctl01._expand(42, this); return false;"><img src="../../../../WebResource.axd%3Fd=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000" alt="+" style="border-width: 0;" /></a><a href="../../using-user-types.aspx.html">Using User Types</a></li><li><a href="../../lazy-loaded-one-to-one-with-nhibernate.aspx.html">Lazy Loaded One-To-One With NHibernate </a></li><li><a href="../../dynamically-change-user-info-in-connection-string.aspx.html">Dynamically change user info in connection string</a></li><li><a href="../../contextual-data-using-nhibernate-filters.aspx.html">Contextual data using NHibernate filters</a></li><li><a href="../../mapping-the-same-class-to-a-view-and-a-table-using-entity-name.aspx.html">Mapping the same class to a view and a table using entity-name</a></li><li><a href="../../creating-an-audit-log-using-nhibernate-events.aspx.html">Creating an Audit Log using NHibernate Events</a></li><li><a href="3.aspx.html#" onclick="ctl00_ctl00_rcr_rcr_ctl00_ctl02_ctl00_ctl01_ctl01._expand(51, this); return false;"><img src="../../../../WebResource.axd%3Fd=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000" alt="+" style="border-width: 0;" /></a><a href="../../create-a-custom-message-interpolator-for-nhibernate-validator.aspx.html">Create a custom message interpolator for NHibernate Validator</a></li><li><a href="../../use-postgresql-arrays-with-nhibernate.aspx.html">Use PostgreSQL Arrays with NHibernate</a></li><li><a href="../../retrieve-a-nested-component-with-criteria-api.aspx.html">Retrieve a nested component with Criteria API</a></li><li><a href="../../tuning-queries-with-ms-sqlserver.aspx.html">Tuning queries with MS SQLServer</a></li><li><a href="../../nhibernate-concurrency-with-oracle-s-ora-rowscn.aspx.html">NHibernate concurrency with Oracle&#39;s ORA_ROWSCN</a></li><li><a href="../../the-best-way-to-get-nhibernate-community-support-submit-precise-description-of-the-problem.aspx.html">The best way to get NHibernate community support ? Submit precise description of the problem</a></li><li><a href="../../simple-audit-metadata-and-logical-deletion-of-business-entities.aspx.html" class="Selected">Simple audit metadata and logical deletion of business entities</a></li><li><a href="../../prefent-nhibernate-from-saving-default-relations.aspx.html">Prefent NHibernate from saving default relations</a></li><li><a href="../../creating-a-custom-id-generator-for-nhibernate.aspx.html">Creating a custom id generator for nHibernate</a></li><li><a href="3.aspx.html#" onclick="ctl00_ctl00_rcr_rcr_ctl00_ctl02_ctl00_ctl01_ctl01._expand(66, this); return false;"><img src="../../../../WebResource.axd%3Fd=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000" alt="+" style="border-width: 0;" /></a><a href="../../finding-dirty-properties-in-nhibernate.aspx.html">Finding Dirty Properties in NHibernate</a></li><li><a href="../../currentsessioncontext-for-desktop-development.aspx.html">CurrentSessionContext for Desktop development</a></li><li><a href="../../customizing-fluent-nhibernate-s-autopersistencemodel-conventions.aspx.html">Customizing Fluent Nhibernate&#39;s AutoPersistenceModel Conventions</a></li><li><a href="../../how-to-use-db2hbm.aspx.html">How to use Db2hbm</a></li><li><a href="../../localization-techniques.aspx.html">Localization techniques</a></li><li><a href="../../calling-oracle-procedure-inside-package.aspx.html">Calling Oracle Procedure inside package</a></li><li><a href="../../how-to-get-help-with-nhibernate.aspx.html">How To Get Help with NHibernate</a></li><li><a href="../../nhibernate-features.aspx.html">NHibernate Features</a></li><li><a href="../../using-nlog-via-common-logging-with-nhibernate.aspx.html">Using NLog via Common.Logging with NHibernate</a></li><li><a href="../../keeping-entity-state-over-multiple-nhibernate-sessions.aspx.html">Keeping Entity State Over Multiple NHibernate Sessions</a></li><li><a href="../../enumerating-first-level-cache-entities.aspx.html">Enumerating First Level Cache Entities</a></li><li><a href="../../hilo-generator-with-node-suffix.aspx.html">HiLo Generator With Node Suffix</a></li><li><a href="../../nhibernate-audit-trails-and-onpreinsert-onpreupdate-event-listeners-vs-save-update-event-listeners.aspx.html">Changing Values in NHibernate Events</a></li><li><a href="../../conventionmodelmapper-amp-net-4-iset-lt-gt.aspx.html">ConventionModelMapper &amp; .net 4 ISet&lt;&gt;</a></li><li><a href="../../conventionmodelmapper-change-manytoone-column-name.aspx.html">ConventionModelMapper - change ManyToOne column name</a></li><li><a href="../../view-the-xml-generated-when-mapping-by-code.aspx.html">View the xml generated when mapping by code</a></li><li><a href="../../net-type-generation-for-nhibernate-mapping-collections.aspx.html">.NET type generation for NHibernate mapping collections</a></li><li><a href="../../a-fully-working-skeleton-for-sexy-loquacious-nh.aspx.html">A fully working skeleton for sexy Loquacious NH</a></li><li><a href="../../checking-if-an-unloaded-collection-contains-elements.aspx.html">Checking if an Unloaded Collection Contains Elements</a></li><li><a href="../../mapping-tables.aspx.html">Mapping tables</a></li><li><a href="../../wcf-nhibernate-entity-serialization.aspx.html">WCF + NHibernate: Entity Serialization</a></li></ul></div>
				        </div>
				        
			        </div>
	            
	    
	        
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Pages</h4>
	                    <div class="CommonContentBoxContent">
	            <div><ul class="CommonHierarchicalList"><li><a href="../../mapping-a-view-and-schema-export-workaround.aspx.html">Mapping a view and Schema Export Workaround</a></li><li><a href="../../lazy-loading-eager-loading.aspx.html">Lazy loading - eager loading</a></li><li><a href="../../configure-log4net-for-use-with-nhibernate.aspx.html">Configure Log4Net for use with NHibernate</a></li><li><a href="../../get-unique-results-from-joined-queries.aspx.html">Get unique results from joined queries</a></li><li><a href="3.aspx.html#" onclick="ctl00_ctl00_rcr_rcr_ctl00_ctl03_ctl00_ctl01_ctl01._expand(30, this); return false;"><img src="../../../../WebResource.axd%3Fd=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000" alt="+" style="border-width: 0;" /></a><a href="../../your-first-nhibernate-based-application.aspx.html">Your first NHibernate based application</a></li><li><a href="../../run-in-medium-trust.aspx.html">Run in Medium Trust</a></li><li><a href="../../pre-generate-lazy-loading-proxies.aspx.html">Pre-Generate Lazy Loading Proxies</a></li><li><a href="3.aspx.html#" onclick="ctl00_ctl00_rcr_rcr_ctl00_ctl03_ctl00_ctl01_ctl01._expand(42, this); return false;"><img src="../../../../WebResource.axd%3Fd=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000" alt="+" style="border-width: 0;" /></a><a href="../../using-user-types.aspx.html">Using User Types</a></li><li><a href="../../lazy-loaded-one-to-one-with-nhibernate.aspx.html">Lazy Loaded One-To-One With NHibernate </a></li><li><a href="../../dynamically-change-user-info-in-connection-string.aspx.html">Dynamically change user info in connection string</a></li><li><a href="../../contextual-data-using-nhibernate-filters.aspx.html">Contextual data using NHibernate filters</a></li><li><a href="../../mapping-the-same-class-to-a-view-and-a-table-using-entity-name.aspx.html">Mapping the same class to a view and a table using entity-name</a></li><li><a href="../../creating-an-audit-log-using-nhibernate-events.aspx.html">Creating an Audit Log using NHibernate Events</a></li><li><a href="3.aspx.html#" onclick="ctl00_ctl00_rcr_rcr_ctl00_ctl03_ctl00_ctl01_ctl01._expand(51, this); return false;"><img src="../../../../WebResource.axd%3Fd=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000" alt="+" style="border-width: 0;" /></a><a href="../../create-a-custom-message-interpolator-for-nhibernate-validator.aspx.html">Create a custom message interpolator for NHibernate Validator</a></li><li><a href="../../use-postgresql-arrays-with-nhibernate.aspx.html">Use PostgreSQL Arrays with NHibernate</a></li><li><a href="../../retrieve-a-nested-component-with-criteria-api.aspx.html">Retrieve a nested component with Criteria API</a></li><li><a href="../../tuning-queries-with-ms-sqlserver.aspx.html">Tuning queries with MS SQLServer</a></li><li><a href="../../nhibernate-concurrency-with-oracle-s-ora-rowscn.aspx.html">NHibernate concurrency with Oracle&#39;s ORA_ROWSCN</a></li><li><a href="../../the-best-way-to-get-nhibernate-community-support-submit-precise-description-of-the-problem.aspx.html">The best way to get NHibernate community support ? Submit precise description of the problem</a></li><li><a href="../../simple-audit-metadata-and-logical-deletion-of-business-entities.aspx.html" class="Selected">Simple audit metadata and logical deletion of business entities</a></li><li><a href="../../prefent-nhibernate-from-saving-default-relations.aspx.html">Prefent NHibernate from saving default relations</a></li><li><a href="../../creating-a-custom-id-generator-for-nhibernate.aspx.html">Creating a custom id generator for nHibernate</a></li><li><a href="3.aspx.html#" onclick="ctl00_ctl00_rcr_rcr_ctl00_ctl03_ctl00_ctl01_ctl01._expand(66, this); return false;"><img src="../../../../WebResource.axd%3Fd=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000" alt="+" style="border-width: 0;" /></a><a href="../../finding-dirty-properties-in-nhibernate.aspx.html">Finding Dirty Properties in NHibernate</a></li><li><a href="../../currentsessioncontext-for-desktop-development.aspx.html">CurrentSessionContext for Desktop development</a></li><li><a href="../../customizing-fluent-nhibernate-s-autopersistencemodel-conventions.aspx.html">Customizing Fluent Nhibernate&#39;s AutoPersistenceModel Conventions</a></li><li><a href="../../how-to-use-db2hbm.aspx.html">How to use Db2hbm</a></li><li><a href="../../localization-techniques.aspx.html">Localization techniques</a></li><li><a href="../../calling-oracle-procedure-inside-package.aspx.html">Calling Oracle Procedure inside package</a></li><li><a href="../../how-to-get-help-with-nhibernate.aspx.html">How To Get Help with NHibernate</a></li><li><a href="../../nhibernate-features.aspx.html">NHibernate Features</a></li><li><a href="../../using-nlog-via-common-logging-with-nhibernate.aspx.html">Using NLog via Common.Logging with NHibernate</a></li><li><a href="../../keeping-entity-state-over-multiple-nhibernate-sessions.aspx.html">Keeping Entity State Over Multiple NHibernate Sessions</a></li><li><a href="../../enumerating-first-level-cache-entities.aspx.html">Enumerating First Level Cache Entities</a></li><li><a href="../../hilo-generator-with-node-suffix.aspx.html">HiLo Generator With Node Suffix</a></li><li><a href="../../nhibernate-audit-trails-and-onpreinsert-onpreupdate-event-listeners-vs-save-update-event-listeners.aspx.html">Changing Values in NHibernate Events</a></li><li><a href="../../conventionmodelmapper-amp-net-4-iset-lt-gt.aspx.html">ConventionModelMapper &amp; .net 4 ISet&lt;&gt;</a></li><li><a href="../../conventionmodelmapper-change-manytoone-column-name.aspx.html">ConventionModelMapper - change ManyToOne column name</a></li><li><a href="../../view-the-xml-generated-when-mapping-by-code.aspx.html">View the xml generated when mapping by code</a></li><li><a href="../../net-type-generation-for-nhibernate-mapping-collections.aspx.html">.NET type generation for NHibernate mapping collections</a></li><li><a href="../../a-fully-working-skeleton-for-sexy-loquacious-nh.aspx.html">A fully working skeleton for sexy Loquacious NH</a></li><li><a href="../../checking-if-an-unloaded-collection-contains-elements.aspx.html">Checking if an Unloaded Collection Contains Elements</a></li><li><a href="../../mapping-tables.aspx.html">Mapping tables</a></li><li><a href="../../wcf-nhibernate-entity-serialization.aspx.html">WCF + NHibernate: Entity Serialization</a></li></ul></div>
				        </div>
				        
			        </div>
	            
	    
	        
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Tags</h4>
	                    <div class="CommonContentBoxContent">
	            <ul class="CommonSidebarTagCloud">
<li class="CommonTag2"><a href="../../tags/Architecture/default.aspx.html" rel="tag">Architecture</a></li>
<li class="CommonTag6"><a href="../../tags/Audit/default.aspx.html" rel="tag">Audit</a></li>
<li class="CommonTag6"><a href="../../tags/Concurrency/default.aspx.html" rel="tag">Concurrency</a></li>
<li class="CommonTag6"><a href="../../tags/Configuration/default.aspx.html" rel="tag">Configuration</a></li>
<li class="CommonTag6"><a href="../../tags/convention+over+configuration/default.aspx.html" rel="tag">convention over configuration</a></li>
<li class="CommonTag6"><a href="../../tags/Conversation/default.aspx.html" rel="tag">Conversation</a></li>
<li class="CommonTag6"><a href="../../tags/entity+name/default.aspx.html" rel="tag">entity name</a></li>
<li class="CommonTag3"><a href="../../tags/events/default.aspx.html" rel="tag">events</a></li>
<li class="CommonTag6"><a href="../../tags/Filters/default.aspx.html" rel="tag">Filters</a></li>
<li class="CommonTag2"><a href="../../tags/FluentNH/default.aspx.html" rel="tag">FluentNH</a></li>
<li class="CommonTag6"><a href="../../tags/IIdentifierGenerator/default.aspx.html" rel="tag">IIdentifierGenerator</a></li>
<li class="CommonTag6"><a href="../../tags/Interceptor/default.aspx.html" rel="tag">Interceptor</a></li>
<li class="CommonTag6"><a href="../../tags/IoC+container/default.aspx.html" rel="tag">IoC container</a></li>
<li class="CommonTag2"><a href="../../tags/IUserType/default.aspx.html" rel="tag">IUserType</a></li>
<li class="CommonTag3"><a href="../../tags/lazy+loading/default.aspx.html" rel="tag">lazy loading</a></li>
<li class="CommonTag6"><a href="../../tags/listener/default.aspx.html" rel="tag">listener</a></li>
<li class="CommonTag6"><a href="../../tags/log/default.aspx.html" rel="tag">log</a></li>
<li class="CommonTag6"><a href="../../tags/logging/default.aspx.html" rel="tag">logging</a></li>
<li class="CommonTag1"><a href="../../tags/Mapping/default.aspx.html" rel="tag">Mapping</a></li>
<li class="CommonTag6"><a href="../../tags/Mapping+by+code/default.aspx.html" rel="tag">Mapping by code</a></li>
<li class="CommonTag1"><a href="../../tags/Nhibernate/default.aspx.html" rel="tag">Nhibernate</a></li>
<li class="CommonTag6"><a href="../../tags/Nhibernate+Documentation/default.aspx.html" rel="tag">Nhibernate Documentation</a></li>
<li class="CommonTag3"><a href="../../tags/property/default.aspx.html" rel="tag">property</a></li>
<li class="CommonTag2"><a href="../../tags/query/default.aspx.html" rel="tag">query</a></li>
<li class="CommonTag1"><a href="../../tags/Session/default.aspx.html" rel="tag">Session</a></li>
</ul>

				        </div>
				        <div class="CommonContentBoxFooter"><a href="../../tags/default.aspx.html">View more</a></div>
			        </div>
	            
	    
	        
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Page Details</h4>
	                    <div class="CommonContentBoxContent">
	            <div class="CustomWikiPageDetailsArea"><div class="CustomWikiPageDetailsTitle">First published by:</div><div class="CustomWikiPageDetailsAvatar"><img src="../../../../utility/anonymous.gif" alt="" style="border-width:0px;max-height:50px;max-width:50px;" /></div><div class="CustomWikiPageDetailsContent"><a href="../../../../members/rcarlomagno/default.aspx.html">Raul Carlomagno</a><br/> on 06-20-2009</div></div><div class="CustomWikiPageDetailsArea"><div class="CustomWikiPageDetailsTitle">Last revision by:</div><div class="CustomWikiPageDetailsAvatar"><img src="../../../../utility/anonymous.gif" alt="" style="border-width:0px;max-height:50px;max-width:50px;" /></div><div class="CustomWikiPageDetailsContent"><a href="../../../../members/rcarlomagno/default.aspx.html">Raul Carlomagno</a><br/> on 06-20-2009</div></div><div class="WikiPageDetailsSummaryArea"><strong>1</strong> person found this article useful.</div>
				        </div>
				        
			        </div>
	            
	    
	    
	    
    </div>
    

			    </div>
                <div id="CommonSidebarLeft">
				    
				</div>
			    <div id="CommonContent"><div id="CommonContentInner">
    



<div class="CommonContentBox">
    <div class="CommonContentBoxContent">
        <div style="float: right">
            
        </div>
        
        <div class="CommonPaneTabSet">
            <div style="overflow: hidden; width: 100%;">
                <table border="0" cellpadding="0" cellspacing="0">
                <tbody>
                    <tr>
                        <td>
                            <div class="CommonPaneTab">
                                <a href="../../simple-audit-metadata-and-logical-deletion-of-business-entities.aspx.html"><img align="absmiddle" border="0" src="../../../../Themes/hawaii/images/wiki/wiki-icon-article-tab.png" alt="" style="border-width:0px;" /></a>                            
                                <a href="../../simple-audit-metadata-and-logical-deletion-of-business-entities.aspx.html">Article</a>
                            </div>
                        </td>
                        <td>
                            
                                    <div class="CommonPaneTab">
                                    
                                    
                                    </div>
                                
                        </td>
                        <td>
                            <div class="CommonPaneTab">
                                <a href="../comments.aspx.html"><img align="absmiddle" border="0" src="../../../../Themes/hawaii/images/wiki/wiki-icon-comment-tab.png" alt="" style="border-width:0px;" /></a>
                                <a href="../comments.aspx.html">Comments</a> (3)
                            </div>
                        </td>
                        <td>
                            <div class="CommonPaneTabSelected">
                                <a href="../history.aspx.html"><img align="absmiddle" border="0" src="../../../../Themes/hawaii/images/wiki/wiki-icon-history-tab.png" alt="" style="border-width:0px;" /></a>
                                <a href="../history.aspx.html">History</a> (4)
                            </div>
                        </td>
                    </tr>
                </tbody>
                </table>
            </div>
        </div>

        <div class="CommonPane">
            <div class="CommonGroupedContentArea">
                <h2 class="CommonContentBoxHeaderSmall"><span><a href="../../simple-audit-metadata-and-logical-deletion-of-business-entities.aspx.html">Simple audit metadata and logical deletion of business entities</a></span></h2>
                <div><p>This article is just about a simple way to achieve auditing and perform logical delete of your sensible data, doing use of the listeners features of NHibernate. Design patterns and arquitecture principles are outside of the scope of the article, this is just an example, take it as a guide.</p>
<p>Remember the old days when you had to audit data stored on your database, every time you build a query to insert, update or delete data, you had to &ldquo;remember&rdquo; to include the values for auditing (timestamp, user id). It was worse if you had stored procedures (by the way, i hate them) because suppose that was needed to take user credentials from another service to audit, you were limited by Transact-SQL language inside the stored procedure to access that service. Anyway, every time you build a query, you need those metadata values to store them, it could be good if you can centralize the place where you obtain and set those values (remember DRY).</p>
<p>Maybe, in a strict way, auditing would take place in the business layer, but we are not going to miss this feature that NHibernate has for us, so auditing will take place in the data access layer. With NHibernate we can override its native methods when performing data access, NHibernate will fire events which we will have to override to audit the data and of course to do a logical deletion of our entities.</p>
<p>Let&rsquo;s get inside the code and explain the domain. In the example we have a BaseEntity for any persistible entity, and then, for the auditable entities, the AuditableEntity which inherits from BaseEntity. We want to audit the cars inside the database. We will audit the date and time, the user, the IP address and the hostname for each action on the entity (insert, update, delete), i think this auditing metada is fine, you can add more of course, your fantasy is your limit.</p>
<p>In fact this can&rsquo;t be called audit, because we are not tracking changes of entities, just who did an action, when and from, pseudoaudit? [:D]</p>
<p><a href="../../add.aspx/$image24.png.html"><img title="image" style="display:inline;border-width:0px;border:0;" alt="image" src="http://i40.tinypic.com/16iijs.png" width="407" border="0" height="712" /></a> </p>
<p>So, the example solution has a test fixture to test the purpose of the example. It was developed with NHibernate 2.1.0.2001.</p>
<p>No more words, show me the code.</p>
<p>Let&rsquo;s see the mapping files.</p>
<h4><b>Car.hbm.xml</b></h4>
<p>&nbsp;</p>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:411b4d59-2c28-4172-ab11-be3aabfc1650" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;overflow:auto;"><span style="color:#0000FF;">&lt;?</span><span style="color:#FF00FF;">xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; </span><span style="color:#0000FF;">?&gt;</span><span style="color:#000000;">
</span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">hibernate-mapping </span><span style="color:#FF0000;">xmlns</span><span style="color:#0000FF;">=&quot;urn:nhibernate-mapping-2.2&quot;</span><span style="color:#FF0000;">
                   assembly</span><span style="color:#0000FF;">=&quot;AuditExample&quot;</span><span style="color:#FF0000;">
                   namespace</span><span style="color:#0000FF;">=&quot;AuditExample.Entities&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
  
  </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">class </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;Car&quot;</span><span style="color:#FF0000;"> table</span><span style="color:#0000FF;">=&quot;cars&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">id </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;Id&quot;</span><span style="color:#FF0000;"> type</span><span style="color:#0000FF;">=&quot;Int64&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
      </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">generator </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">=&quot;hilo&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
        </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">param </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;max_lo&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">50</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">param</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
      </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">generator</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">id</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">

    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;BrandName&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;brand_name&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;ModelName&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;model_name&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;Kilometers&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;kilometers&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
      
    </span><span style="color:#008000;">&lt;!--</span><span style="color:#008000;">audit attributes</span><span style="color:#008000;">--&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">many-to-one </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;AddedBy&quot;</span><span style="color:#FF0000;"> class</span><span style="color:#0000FF;">=&quot;AuditExample.Entities.User, AuditExample&quot;</span><span style="color:#FF0000;">
        column</span><span style="color:#0000FF;">=&quot;added_user_id&quot;</span><span style="color:#FF0000;"> not-null</span><span style="color:#0000FF;">=&quot;false&quot;</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;AddedDate&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;added_date&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;AddedFromIP&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;added_from_ip&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;AddedFromHostName&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;added_from_hostname&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">many-to-one </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;ModifiedBy&quot;</span><span style="color:#FF0000;"> class</span><span style="color:#0000FF;">=&quot;AuditExample.Entities.User, AuditExample&quot;</span><span style="color:#FF0000;">
        column</span><span style="color:#0000FF;">=&quot;modified_user_id&quot;</span><span style="color:#FF0000;"> not-null</span><span style="color:#0000FF;">=&quot;false&quot;</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;ModifiedDate&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;modified_date&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;ModifiedFromIP&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;modified_from_ip&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;ModifiedFromHostName&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;modified_from_hostname&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">    
    
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">many-to-one </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;ErasedBy&quot;</span><span style="color:#FF0000;"> class</span><span style="color:#0000FF;">=&quot;AuditExample.Entities.User, AuditExample&quot;</span><span style="color:#FF0000;">
        column</span><span style="color:#0000FF;">=&quot;erased_user_id&quot;</span><span style="color:#FF0000;"> not-null</span><span style="color:#0000FF;">=&quot;false&quot;</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;ErasedDate&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;erased_date&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;ErasedFromIP&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;erased_from_ip&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;ErasedFromHostName&quot;</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= &quot;erased_from_hostname&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">

    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">filter </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;avoidLogicalDeleted&quot;</span><span style="color:#FF0000;"> condition</span><span style="color:#0000FF;">=&quot;erased_date IS NULL&quot;</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    
  </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">class</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
  
  </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">filter-def </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;avoidLogicalDeleted&quot;</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
  
</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">hibernate-mapping</span><span style="color:#0000FF;">&gt;</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<p>It has the Id, 3 owned properties, and 9 properties for metadata auditing. The filter part is about logical deletes, we are going to talk about it in later. </p>
<p>The <b>User.hbm.xml </b>is really simple, we are not going to show it, it has no sense, anyway, the example solution can be downloaded.</p>
<p>Now it&rsquo;s time to show the NHibernate configuration file.</p>
<h4><b>hibernate.cfg.xml</b></h4>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:3ba95b40-497a-4b28-8b49-14fc1742bf02" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:pre-wrap;word-wrap:break-word;overflow:auto;"><span style="color:#0000FF;">&lt;?</span><span style="color:#FF00FF;">xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;</span><span style="color:#0000FF;">?&gt;</span><span style="color:#000000;">
</span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">hibernate-configuration  </span><span style="color:#FF0000;">xmlns</span><span style="color:#0000FF;">=&quot;urn:nhibernate-configuration-2.2&quot;</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
  </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">session-factory</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;connection.driver_class&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">NHibernate.Driver.SqlClientDriver</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;connection.connection_string&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
      Server=(local)\SQLEXPRESS;initial catalog=auditexample;Integrated Security=SSPI
    </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;adonet.batch_size&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">10</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;show_sql&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">false</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;dialect&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">NHibernate.Dialect.MsSql2005Dialect</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;query.substitutions&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">true 1, false 0, yes &#39;Y&#39;, no &#39;N&#39;</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">=&quot;proxyfactory.factory_class&quot;</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
        NHibernate.ByteCode.Castle.ProxyFactoryFactory, NHibernate.ByteCode.Castle
    </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">mapping </span><span style="color:#FF0000;">assembly</span><span style="color:#0000FF;">=&quot;AuditExample&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">listener </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">=&quot;AuditExample.NHExtensions.CustomSaveUpdateEventListener, AuditExample&quot;</span><span style="color:#FF0000;">
        type</span><span style="color:#0000FF;">=&quot;save-update&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">
    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">listener </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">=&quot;AuditExample.NHExtensions.CustomDeleteEventListener, AuditExample&quot;</span><span style="color:#FF0000;">
        type</span><span style="color:#0000FF;">=&quot;delete&quot;</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">    
  </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">session-factory</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">
</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">hibernate-configuration</span><span style="color:#0000FF;">&gt;</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<p>Let&rsquo;s analyze it, in the configuration file there is an attribute that is not so common, the listener attribute, as we mention before, with these attributes we are forcing NHibernate to lookup for the custom event listener that we inherited from the default listeners for ISession.Delete() and ISession.SaveUpdate() methods. Inside both class CustomSaveUpdateEventListener and CustomDeleteEventListener will appear a class called SecurityContext which handles the metada for auditing, this class will be discused later, after explaining both listeners.</p>
<h4><b>CustomSaveUpdateEventListener.cs</b></h4>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:e2d0d747-e26f-4d1c-a83b-59a459662651" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:pre-wrap;word-wrap:break-word;overflow:auto;"><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">class</span><span style="color:#000000;"> CustomSaveUpdateEventListener : DefaultSaveOrUpdateEventListener
{
   </span><span style="color:#0000FF;">protected</span><span style="color:#000000;"> </span><span style="color:#0000FF;">override</span><span style="color:#000000;"> </span><span style="color:#0000FF;">object</span><span style="color:#000000;"> PerformSaveOrUpdate(SaveOrUpdateEvent evt)
   {
       var entity </span><span style="color:#000000;">=</span><span style="color:#000000;"> evt.Entity </span><span style="color:#0000FF;">as</span><span style="color:#000000;"> AuditableEntity;

          </span><span style="color:#0000FF;">if</span><span style="color:#000000;"> (entity </span><span style="color:#000000;">!=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">){
              </span><span style="color:#0000FF;">if</span><span style="color:#000000;"> (entity.Id </span><span style="color:#000000;">==</span><span style="color:#000000;"> </span><span style="color:#800080;">0</span><span style="color:#000000;">)
                  ProcessEntityForInserting(entity);
              </span><span style="color:#0000FF;">else</span><span style="color:#000000;">
                  ProcessEntityForUpdating(entity);
          }
       
          </span><span style="color:#0000FF;">return</span><span style="color:#000000;"> </span><span style="color:#0000FF;">base</span><span style="color:#000000;">.PerformSaveOrUpdate(evt);
   }

   </span><span style="color:#0000FF;">internal</span><span style="color:#000000;"> </span><span style="color:#0000FF;">virtual</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> ProcessEntityForInserting(AuditableEntity entity)
    {
       entity.AddedDate </span><span style="color:#000000;">=</span><span style="color:#000000;"> DateTime.Now;
       entity.AddedBy </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.LoggedUser </span><span style="color:#000000;">??</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">;
       entity.AddedFromIP </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostIP();
       entity.AddedFromHostName </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostName();
    }

   </span><span style="color:#0000FF;">internal</span><span style="color:#000000;"> </span><span style="color:#0000FF;">virtual</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> ProcessEntityForUpdating(AuditableEntity entity)
    {
       entity.ModifiedDate </span><span style="color:#000000;">=</span><span style="color:#000000;"> DateTime.Now;
       entity.ModifiedBy </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.LoggedUser </span><span style="color:#000000;">??</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">;
       entity.ModifiedFromIP </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostIP();
       entity.ModifiedFromHostName </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostName();
    }
}</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<h4><b>CustomDeleteEventListener.cs</b></h4>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:0d9f2bf9-3a0b-4402-832d-e0e844f30d37" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:pre-wrap;word-wrap:break-word;overflow:auto;"><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">class</span><span style="color:#000000;"> CustomDeleteEventListener : DefaultDeleteEventListener
{
    </span><span style="color:#0000FF;">protected</span><span style="color:#000000;"> </span><span style="color:#0000FF;">override</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> DeleteEntity(IEventSource session, </span><span style="color:#0000FF;">object</span><span style="color:#000000;"> entity,
                        NHibernate.Engine.EntityEntry entityEntry,
                        </span><span style="color:#0000FF;">bool</span><span style="color:#000000;"> isCascadeDeleteEnabled,
                        NHibernate.Persister.Entity.IEntityPersister persister,
                        Iesi.Collections.ISet transientEntities)
   {
        var auditableEntity </span><span style="color:#000000;">=</span><span style="color:#000000;"> entity </span><span style="color:#0000FF;">as</span><span style="color:#000000;"> AuditableEntity;

           </span><span style="color:#0000FF;">if</span><span style="color:#000000;"> (auditableEntity </span><span style="color:#000000;">!=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">){
              ProcessEntityForLogicalDelete(auditableEntity);
               </span><span style="color:#0000FF;">this</span><span style="color:#000000;">.CascadeBeforeDelete(session, persister, entity,
                   entityEntry, transientEntities);
               </span><span style="color:#0000FF;">this</span><span style="color:#000000;">.CascadeAfterDelete(session, persister, entity,
                   transientEntities);
       } </span><span style="color:#0000FF;">else</span><span style="color:#000000;"> {
            </span><span style="color:#008000;">//</span><span style="color:#008000;">normal delete</span><span style="color:#008000;">
</span><span style="color:#000000;">               </span><span style="color:#0000FF;">base</span><span style="color:#000000;">.DeleteEntity(session, entity, entityEntry,
                isCascadeDeleteEnabled, persister, transientEntities);
       }
   }

   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> ProcessEntityForLogicalDelete(AuditableEntity entity)
   {
        entity.ErasedDate </span><span style="color:#000000;">=</span><span style="color:#000000;"> DateTime.Now;
        entity.ErasedBy </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.LoggedUser </span><span style="color:#000000;">??</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">;
        entity.ErasedFromIP </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostIP();
        entity.ErasedFromHostName </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostName();
   }
}</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<h4><b>SecurityContext.cs</b></h4>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:64c46d35-180d-4eea-b740-092564076a3d" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:pre-wrap;word-wrap:break-word;overflow:auto;"><span style="color:#808080;">///</span><span style="color:#008000;"> </span><span style="color:#808080;">&lt;summary&gt;</span><span style="color:#008000;">
</span><span style="color:#808080;">///</span><span style="color:#008000;"> Ridiculous simple crosscut security class to get user credentials and audit metadata
</span><span style="color:#808080;">///</span><span style="color:#008000;"> </span><span style="color:#808080;">&lt;/summary&gt;</span><span style="color:#808080;">
</span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">static</span><span style="color:#000000;"> </span><span style="color:#0000FF;">class</span><span style="color:#000000;"> SecurityContext
{
    </span><span style="color:#008000;">//</span><span style="color:#008000;">maybe System.Security.Principal.WindowsIdentity.GetCurrent().Name.ToString(), you decide</span><span style="color:#008000;">
</span><span style="color:#000000;">    </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">static</span><span style="color:#000000;"> User LoggedUser {</span><span style="color:#0000FF;">get</span><span style="color:#000000;">; </span><span style="color:#0000FF;">set</span><span style="color:#000000;">;}

    </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">static</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> GetHostName()
    {
        </span><span style="color:#0000FF;">return</span><span style="color:#000000;"> Dns.GetHostName();
    }

   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">static</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> GetHostIP()
   {
        IPAddress[] addresses </span><span style="color:#000000;">=</span><span style="color:#000000;"> Dns.GetHostAddresses(Dns.GetHostName());
        
        </span><span style="color:#008000;">//</span><span style="color:#008000;">be carefull and filter the public ip, use the local one
        </span><span style="color:#008000;">//</span><span style="color:#008000;">and of course, this has no sense for an httpcontext, use remote host ip instead</span><span style="color:#008000;">
</span><span style="color:#000000;">        </span><span style="color:#0000FF;">if</span><span style="color:#000000;"> (addresses.Length </span><span style="color:#000000;">&gt;</span><span style="color:#000000;"> </span><span style="color:#800080;">0</span><span style="color:#000000;">)
            </span><span style="color:#0000FF;">return</span><span style="color:#000000;"> addresses[</span><span style="color:#800080;">0</span><span style="color:#000000;">].ToString();
        </span><span style="color:#0000FF;">else</span><span style="color:#000000;">
            </span><span style="color:#0000FF;">return</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">;
   }
}</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<p>This class is just a simple helper to get the metadata needed for auditing, in this example it holds the session of the logged user too.</p>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:a58b502c-190d-4d18-9988-4eed1524b883" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:pre-wrap;word-wrap:break-word;overflow:auto;"><span style="color:#000000;">[TestFixture]
</span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">class</span><span style="color:#000000;"> AuditTest
{
   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> Configuration _configuration;
   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> ISessionFactory _sessionFactory;

   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> User _sampleUser1;
   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> User _sampleUser2;

   [TestFixtureSetUp]
   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> TestFixtureSetUp()
   {
       XmlConfigurator.Configure();

       _configuration </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> Configuration();
       _configuration.Configure();
       _sessionFactory </span><span style="color:#000000;">=</span><span style="color:#000000;"> _configuration.BuildSessionFactory();

       </span><span style="color:#008000;">//</span><span style="color:#008000;">drop all tables on database</span><span style="color:#008000;">
</span><span style="color:#000000;">       _sessionFactory.OpenSession().CreateSQLQuery(
               </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">IF OBJECT_ID (N&#39;dbo.cars&#39;, N&#39;U&#39;) IS NOT NULL DELETE cars</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">
        ).ExecuteUpdate();
       
       _sessionFactory.OpenSession().CreateSQLQuery(
               </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">IF OBJECT_ID (N&#39;dbo.users&#39;, N&#39;U&#39;) IS NOT NULL DELETE users</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">
        ).ExecuteUpdate();
       
       _sessionFactory.OpenSession().CreateSQLQuery(
               </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">EXEC sp_MSforeachtable ?</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">
        ).SetParameter(</span><span style="color:#800080;">0</span><span style="color:#000000;">,</span><span style="color:#800000;">&quot;</span><span style="color:#800000;">DROP TABLE ?</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">).ExecuteUpdate();

       </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> SchemaExport(_configuration).Create(</span><span style="color:#0000FF;">false</span><span style="color:#000000;">, </span><span style="color:#0000FF;">true</span><span style="color:#000000;">);

       PrepareLoggedUsers();
   }

   [TestFixtureTearDown]
   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> TestFixtureTearDown()
   {
       </span><span style="color:#008000;">//</span><span style="color:#008000;">new SchemaExport(_configuration).Drop(false, true);</span><span style="color:#008000;">
</span><span style="color:#000000;">       _sessionFactory.Close();
   }

   [SetUp]
   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> TestSetUp()
   {
       _sessionFactory.OpenSession().CreateQuery(</span><span style="color:#800000;">&quot;</span><span style="color:#800000;">delete Car</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">).ExecuteUpdate();
   }

   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> PrepareLoggedUsers()
   {
       _sampleUser1 </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> User() { Login </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">rcarlomagno</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">, Name </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">Raul</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">,
               LastName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">Carlomagno</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">, Password </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">jijiji</span><span style="color:#800000;">&quot;</span><span style="color:#000000;"> };
       _sampleUser2 </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> User() { Login </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">ndaponte</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">, Name </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">Nadia</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">,
               LastName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">Daponte</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">, Password </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">jujujuju</span><span style="color:#800000;">&quot;</span><span style="color:#000000;"> };

       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())
       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())
       {
           session.Save(_sampleUser1);
           session.Save(_sampleUser2);
           transaction.Commit();
       }

       SecurityContext.LoggedUser </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sampleUser1;
   }

   [Test]
   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> CanAuditAddedEntity()
   {
       Car car </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> Car() { BrandName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">Renault</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">, ModelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">Clio</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">,
               Kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800080;">110000</span><span style="color:#000000;"> };
       </span><span style="color:#0000FF;">long</span><span style="color:#000000;"> carId;

       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())
       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())
       {
           session.SaveOrUpdate(car);
           transaction.Commit();
           carId </span><span style="color:#000000;">=</span><span style="color:#000000;"> car.Id;
       }

       car </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession().Get</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">(carId);

       Assert.IsNotNull(car);
       Assert.IsNotNull(car.AddedDate);
       Assert.IsNotNull(car.AddedBy);
       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.AddedFromHostName));
       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.AddedFromIP));
   }

   [Test]
   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> CanAuditModifiedEntity()
   {
       </span><span style="color:#0000FF;">long</span><span style="color:#000000;"> carId;
       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> brandName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">Ford</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">;
       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> modelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">Ka</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">;
       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">long</span><span style="color:#000000;"> kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800080;">97544</span><span style="color:#000000;">;

       Car car </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> Car() { BrandName </span><span style="color:#000000;">=</span><span style="color:#000000;"> brandName, ModelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> modelName,
               Kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> kilometers };

       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())
       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())
       {
           session.SaveOrUpdate(car);
           transaction.Commit();
           carId </span><span style="color:#000000;">=</span><span style="color:#000000;"> car.Id;
       }

       car </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession().Get</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">(carId);

       Assert.IsNotNull(car);
       Assert.IsNotNull(car.AddedDate);
       Assert.IsNotNull(car.AddedBy);


       </span><span style="color:#008000;">//</span><span style="color:#008000;">let&#39;s change logged user and wait 2 seconds to change the car&#39;s data</span><span style="color:#008000;">
</span><span style="color:#000000;">       SecurityContext.LoggedUser </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sampleUser2;
       Thread.Sleep(</span><span style="color:#800080;">2000</span><span style="color:#000000;">);

       car.Kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800080;">54000</span><span style="color:#000000;">;
       car.ModelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">Fiesta</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">;

       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())
       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())
       {
           session.SaveOrUpdate(car);
           transaction.Commit();
       }

       car </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession().Get</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">(carId);

       Assert.IsNotNull(car);
       Assert.IsNotNull(car.ModifiedBy);
       Assert.IsNotNull(car.ModifiedDate);
       Assert.AreNotEqual(car.ModifiedDate, car.AddedDate);
       Assert.AreNotEqual(car.ModifiedBy, car.AddedBy);
       Assert.AreNotEqual(car.Kilometers, kilometers);
       Assert.AreNotEqual(car.ModelName, modelName);
       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.ModifiedFromHostName));
       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.ModifiedFromIP));
   }

   [Test]
   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> CanAuditErasedEntity()
   {
       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> brandName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">Citroen</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">;
       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> modelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">&quot;</span><span style="color:#800000;">C3</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">;
       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">long</span><span style="color:#000000;"> kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800080;">74665</span><span style="color:#000000;">;
       </span><span style="color:#0000FF;">long</span><span style="color:#000000;"> carId;

       Car car </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> Car() { BrandName </span><span style="color:#000000;">=</span><span style="color:#000000;"> brandName, ModelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> modelName,
               Kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> kilometers };

       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())
       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())
       {
           session.SaveOrUpdate(car);
           transaction.Commit();
           carId </span><span style="color:#000000;">=</span><span style="color:#000000;"> car.Id;
       }

       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())
       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())
       {
           session.Delete(car);
           transaction.Commit();
       }

       car </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession().Get</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">(carId);

       Assert.IsNotNull(car);
       Assert.IsNotNull(car.ErasedBy);
       Assert.IsNotNull(car.ErasedDate);
       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.ErasedFromHostName));
       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.ErasedFromIP));

       ISession tmpSession </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession();
       tmpSession.EnableFilter(</span><span style="color:#800000;">&quot;</span><span style="color:#800000;">avoidLogicalDeleted</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">);
       Assert.AreEqual(</span><span style="color:#800080;">0</span><span style="color:#000000;">, tmpSession.CreateCriteria</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">().List().Count);
       tmpSession.DisableFilter(</span><span style="color:#800000;">&quot;</span><span style="color:#800000;">avoidLogicalDeleted</span><span style="color:#800000;">&quot;</span><span style="color:#000000;">);
       Assert.AreEqual(</span><span style="color:#800080;">1</span><span style="color:#000000;">, tmpSession.CreateCriteria</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">().List().Count);

   }
}</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<p>This test fixture proves that i am not lying. :-)</p>
<p>A few last words, in CanAuditErasedEntity() method, at the end of it, it is supposed that if we deleted logically an entity, we don&rsquo;t want to see it in the results, so before doing a Criteria or HQL to get some data, we must enable the filter on the ISession, because filters are disabled by default. I do not know if there is a way to enable it on the ISessionFactory, to avoid manually enable it each time we want to get some data.</p>
<p>Well, this is the first time i write an article, i hope the next will be better. Sorry for my english.</p>
<p><a href="http://www.2shared.com/file/6380003/67d562c8/AuditExample.html">Solution Download</a></p></div>
            </div>
        </div>

    </div>
</div>


</div></div>
			    <div style="clear: both;"></div>
			    
			    
            </div>
                
            <div id="CommonFooter">
                <div class="Common">
                    
                        
                	    
                        

                        
                                <a href="http://communityserver.com/" target="_blank"><img src="../../../../utility/PoweredByCS_commercial.gif" alt="Powered by Community Server (Commercial Edition), by Telligent Systems " style="border-width:0px;" /></a>
		                    
                		
                    
                 </div>
            </div>
		
<script type="text/javascript">
// <![CDATA[
Telligent_Modal.Configure('/utility/loading.htm',['CommonModal'],['CommonModalTitle'],['CommonModalClose'],['CommonModalContent'],['CommonModalFooter'],['CommonModalResize'],['CommonModalMask'],100,false,true);
// ]]>
</script><script type="text/javascript">
<!--
function KeyDownHandlerctl00_ctl00_sr_sr_ctl00_ctl00_TitleBarSearchButton(event)
{
	if (event.keyCode == 13)
	{
		event.returnValue = false;
		event.cancel = true;
     __doPostBack('ctl00$ctl00$sr$sr$ctl00$ctl00$TitleBarSearchButton','')
   return false;
	}
}

//-->
</script>
<script type="text/javascript">
// <![CDATA[
window.ctl00_ctl00_rcr_rcr_ctl00_ctl02_ctl00_ctl01_ctl01=new WikiPageHierarchy('ctl00_ctl00_rcr_rcr_ctl00_ctl02_ctl00_ctl01_ctl01',new Function('mode','pageId','callback','WebForm_DoCallback(\'ctl00$ctl00$rcr$rcr$ctl00$ctl02$ctl00$ctl01$ctl01\',mode + \':\' + pageId,callback,\"\",null,false)'),'<img src="http://nhforge.org/wikis/howtonh/simple-audit-metadata-and-logical-deletion-of-business-entities/revision/\&quot;/WebResource.axd?d=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000\&quot;" alt=\"+\" style=\"border-width: 0;\" />','<img src="http://nhforge.org/wikis/howtonh/simple-audit-metadata-and-logical-deletion-of-business-entities/revision/\&quot;/WebResource.axd?d=I7Z2L5Ca7ffItUeObf-LA3ykZ3Mbmr-vwfNJv2PfNk2O4alHWIJbJADyKhl0k71mJCpGTePjifKqZQx_Rs64LrGhlEU25qRjlCh8LoYwo2tck8EIbBdQKg5CISopk9hz_6ZbK_GNtBJljwOq57_FBvxYCTM1&amp;t=634395149500000000\&quot;" alt=\"-\" style=\"border-width: 0;\" />','<div>Loading...</div>');
// ]]>
</script><script type="text/javascript">
// <![CDATA[
window.ctl00_ctl00_rcr_rcr_ctl00_ctl03_ctl00_ctl01_ctl01=new WikiPageHierarchy('ctl00_ctl00_rcr_rcr_ctl00_ctl03_ctl00_ctl01_ctl01',new Function('mode','pageId','callback','WebForm_DoCallback(\'ctl00$ctl00$rcr$rcr$ctl00$ctl03$ctl00$ctl01$ctl01\',mode + \':\' + pageId,callback,\"\",null,false)'),'<img src="http://nhforge.org/wikis/howtonh/simple-audit-metadata-and-logical-deletion-of-business-entities/revision/\&quot;/WebResource.axd?d=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000\&quot;" alt=\"+\" style=\"border-width: 0;\" />','<img src="http://nhforge.org/wikis/howtonh/simple-audit-metadata-and-logical-deletion-of-business-entities/revision/\&quot;/WebResource.axd?d=I7Z2L5Ca7ffItUeObf-LA3ykZ3Mbmr-vwfNJv2PfNk2O4alHWIJbJADyKhl0k71mJCpGTePjifKqZQx_Rs64LrGhlEU25qRjlCh8LoYwo2tck8EIbBdQKg5CISopk9hz_6ZbK_GNtBJljwOq57_FBvxYCTM1&amp;t=634395149500000000\&quot;" alt=\"-\" style=\"border-width: 0;\" />','<div>Loading...</div>');
// ]]>
</script><script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-5443308-1");
pageTracker._trackPageview();
</script></form>
		
	</body>
</html>
