

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head><meta http-equiv="X-UA-Compatible" content="IE=7" /><meta name="robots" content="index,follow" />
<meta name="description" content="The official NHibernate community site. Download NHibernate. Read blogs. Contribute to the NHibernate Wiki. Find reference documentation." />
<meta name="keywords" content="NHibernate, NHibernate Contrib, community, Burrow, Downloads" />
<meta name="GENERATOR" content="CommunityServer 2008.5 SP1 (Build: 31106.3070)" />
<link rel="shortcut icon" type="image/ico" href="../../../../favicon.ico" />
<link rel="alternate" type="application/rss+xml" title="NHibernate and the Unit of Work Pattern (RSS 2.0)" href="../rss.aspx"  />
<link rel="alternate" type="application/rss+xml" title="Patterns &amp; Practices (RSS 2.0)" href="../../rss.aspx"  />
<link rel="alternate" type="application/rss+xml" title="gabriel.schenker&#39;s Announcements (RSS 2.0)" href="../../../../members/gabriel.schenker/announcements/rss.aspx"  />
<link rel="alternate" type="application/rss+xml" title="gabriel.schenker&#39;s Comments (RSS 2.0)" href="../../../../members/gabriel.schenker/comments/rss.aspx"  />
<link rel="alternate" type="application/rss+xml" title="gabriel.schenker&#39;s Activities (RSS 2.0)" href="../../../../members/gabriel.schenker/activities/rss.aspx"  />
<link rel="alternate" type="application/rss+xml" title="gabriel.schenker&#39;s Friends Activity (RSS 2.0)" href="../../../../members/gabriel.schenker/activities/friendrss.aspx"  />

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <style type="text/css"> body { font-size: 84%; } </style>
        <link rel="stylesheet" href="../../../../themes/hawaii/style/Common.css" type="text/css" media="screen,print" />
        <link rel="stylesheet" href="../../../../themes/hawaii/style/common_print.css" type="text/css" media="print" />
        
    
    <link rel="stylesheet" href="../../../../Themes/hawaii/style/wiki.css" type="text/css" media="screen,print" />
	

        <link rel="stylesheet" href="../../../../themes/hawaii/style/DynamicStyle.aspx.css" type="text/css" media="screen" />
        <!--[if lte IE 6]>
            <link rel="stylesheet" href="/themes/hawaii/style/ie6.css" type="text/css" media="screen" />
        <![endif]-->
    <meta name="google-site-verification" content="u9qihpHbzSFdf2ypCUvCQrj9IJkANGzorC8zMk0859M" />
<title>
	NHibernate and the Unit of Work Pattern: Revision #1 - NHibernate Forge
</title></head>
	<body>
		<form name="aspnetForm" method="post" action="1.aspx.html" id="aspnetForm">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwULLTE2ODYxODYyODBkGAEFHl9fQ29udHJvbHNSZXF1aXJlUG9zdEJhY2tLZXlfXxYBBTBjdGwwMCRjdGwwMCRzciRzciRjdGwwMCRjdGwwMCRUaXRsZUJhclNlYXJjaFRleHRS2dku67jB2SYXikwjMUBFR1YWDw==" />
</div>


<script src="../../../../WebResource.axd%3Fd=0gbcOAOlbWsHyCtP1tLKZQbpxrEkhg31E8L04T1x-hMLrsMonvmUNQvxBohSywWHueFgWT841lW9e5k7Gp2DbPsOLeN3Sv3SB7czfVSlQGxYOHnJcLlKfh3v9vlcjJ9ggvps0fjahw73J3SVYQmGvS0rXng1&amp;t=634395149500000000" type="text/javascript"></script>
<script src="../../../../WebResource.axd%3Fd=qXX_qxw7Y60qjc1NsxHnuIWUCy9JxjEUKLrY5KEQyuYhKzv3UmRPH805gTXU5edfSsLl7PHTIDuZbzGOp5UYEWeQ6anyqFa-m5TiNnZiD5MOrgiKWAZBgPyJ267gdCbk0_TpK2BaAhLvEgyM28dt9SYQ2UM1&amp;t=634395149500000000" type="text/javascript"></script>
<script src="../../../../WebResource.axd%3Fd=c5kkseX-7hUDg441H_iVoy5ws7YKvwS4KliHEKHuRl5UdJkUU5Jbdf2sxzCcbfyn6sqe17DzqhSTfAyV8nyJKMHhScl2IzjSz37RVYryN9Omis3K0NCj_OJ4fHZH3n9_IPBlNLVyYL45kjJL_zhydrkKTi3FfxaImDeS_1JZIO7o9iFs0&amp;t=634395149500000000" type="text/javascript"></script>
						

			

		    
		        <div id="CommonHeader">
		            <div class="Common">
		                <div id="CommonHeaderTitleArea">
		                    <table cellpadding="0" cellspacing="0" border="0"><tr valign="middle">
		                        <td><div style="margin-right: 10px;"><img src="../../../../cfs-file_ashx/__key/CommunityServer.Components.SiteFiles/logos/LogoNH.gif" alt="" style="border-width:0px;" /></div></td>
		                        <td>
		                            <div class="CommonHeaderTitle">NHibernate Forge</div>
		                            <div class="CommonHeaderTitleDescription">The official new home for the NHibernate for .NET community</div>
		                        </td>
		                    </tr></table>
		                </div>
		                <div id="CommonHeaderUserArea">
		                    <table cellpadding="0" cellspacing="0" border="0"><tr valign="top"><td>
                                <div id="CommonHeaderUserContent">
                                    <div id="CommonHeaderUserWelcome">
                                        
        <a href="http://nhforge.org/login.aspx?ReturnUrl=%2fwikis%2fpatternsandpractices%2fnhibernate-and-the-unit-of-work-pattern%2frevision%2f1.aspx">Sign in </a>
         | <a href="../../../../user/CreateUser.aspx%3FReturnUrl=.html">Join</a>
        | <a href="http://dev.communityserver.com/r.ashx?K&amp;siteurl=wikis.wiki_Page_ViewRevision">Help</a>
     


                                    </div>
                                </div>
                            </td></tr></table>
                        </div>
                    </div>
                </div>
                <div id="CommonNavigation">
                    <div class="Common"><div class="Inner">
                        <ul>
                                
                                <li><a href="../../../../index.html">Home</a></li>
                            
                                
                                <li><a href="../../../../blogs/nhibernate.html">Blog</a></li>
                            
                                <li><a class="Selected" href="../../../index.html">Wikis</a></li>
                                
                            
                                
                                <li><a href="../../../../groups/index.html">Groups</a></li>
                            
                                
                                <li><a href="../../../../doc/nh/en/index.html">Reference</a></li>
                            
                                
                                <li><a href="http://nhibernate.jira.com">Issue tracker</a></li>
                            
                                
                                <li><a href="https://github.com/nhibernate/nhibernate-core">Source Code</a></li>
                            </ul>
                        <div style="clear: both;"></div>
                     </div></div>
                </div>
                
                        <div id="CommonNavigation2">
                            <div class="Common"><div class="Inner">
                                <ul>
                    
                        
                        <li><a href="../../../general/default.aspx.html">General</a></li>
                    
                        
                        <li><a href="../../../howtonh/default.aspx.html">How to</a></li>
                    
                        <li><a class="Selected" href="../../default.aspx.html">Patterns&Practices</a></li>
                        
                    
                                </ul>
                            </div></div>
                        </div>
                    
                <div id="CommonNavigationShadow">
                    
    
    <div class="CommonBreadCrumbArea"><div class="Common">
        <a href="../../../index.html">Wikis</a>
        &raquo;
        <a href="../../default.aspx.html">Patterns &amp; Practices</a>
        &raquo;
        <a href="../../nhibernate-and-the-unit-of-work-pattern.aspx.html">NHibernate and the Unit of Work Pattern</a>
        &raquo;
        Revision #1
    </div></div>


                </div>
		    
                        
            <div class="Common">
            
                
            
                <div id="CommonSearch">
                    
    
        
                <div class="CommonSearchArea">
                    <div class="CommonSearchRoundTop"><div class="r1"></div><div class="r2"></div><div class="r3"></div><div class="r4"></div></div>
                    <div class="CommonSearchContent"><div class="CommonSearchContentInner">
                        <input name="ctl00$ctl00$sr$sr$ctl00$ctl00$TitleBarSearchText" type="text" maxlength="64" size="15" id="ctl00_ctl00_sr_sr_ctl00_ctl00_TitleBarSearchText" onclick="if(this.defaultValue==this.value) this.value='';" onblur="if(this.value=='') this.value=this.defaultValue;" onkeydown="return KeyDownHandlerctl00_ctl00_sr_sr_ctl00_ctl00_TitleBarSearchButton(event);" /><input type="submit" name="ctl00$ctl00$sr$sr$ctl00$ctl00$TitleBarSearchButton" value="Â " id="ctl00_ctl00_sr_sr_ctl00_ctl00_TitleBarSearchButton" class="CommonSearchButton" />
                    </div></div>
                    <div class="CommonSearchRoundBottom"><div class="r1"></div><div class="r2"></div><div class="r3"></div><div class="r4"></div></div>
                </div>
            
    

                </div>
                <div id="CommonTitle">
                    
    
    <h1 class="CommonTitle">NHibernate and the Unit of Work Pattern: 
            Revision #1
        </h1>


                </div>
                <div style="clear: both;"></div>
			    <div id="CommonSidebarRight">
			        
    
	<div class="CommonSidebar">
	    
	    
	        
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Shortcuts</h4>
	                    <div class="CommonContentBoxContent">
	            <ul class='CommonSidebarList'><li><a href="../../default.aspx.html">Home</a></li><li><a href="../rss.aspx">RSS feed for page</a></li></ul>
				        </div>
				        
			        </div>
	            
	    
	        
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Attachments</h4>
	                    <div class="CommonContentBoxContent">
	            <ul class="CommonSidebarList"><li><a href="../../../../cfs-file_ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate.UoW/UoW-UoW_2D00_class.png">UoW UoW-class.png</a></li><li><a href="../../../../cfs-file_ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate.UoW/UoW-Solution.png">UoW Solution.png</a></li><li><a href="../../../../cfs-file_ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate.UoW/UoW-UoW_2D00_Factory.png">UoW UoW-Factory.png</a></li><li><a href="../../../../cfs-file_ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate.UoW/UoW-overview.png">UoW overview.png</a></li><li><a href="../../../../cfs-file_ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/nhibernate.UoW/UoW-Multi_2D00_Threading-UnitTest.png">UoW Multi-Threading UnitTest.png</a></li></ul>
				        </div>
				        
			        </div>
	            
	    
	        
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Wiki Page Hierarchy</h4>
	                    <div class="CommonContentBoxContent">
	            <div><ul class="CommonHierarchicalList"><li><a href="../../nhibernate-and-the-unit-of-work-pattern.aspx.html" class="Selected">NHibernate and the Unit of Work Pattern</a></li><li><a href="../../identity-field-equality-and-hash-code.aspx.html">Identity Field, Equality and Hash Code</a></li></ul></div>
				        </div>
				        
			        </div>
	            
	    
	        
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Pages</h4>
	                    <div class="CommonContentBoxContent">
	            <div><ul class="CommonHierarchicalList"><li><a href="../../nhibernate-and-the-unit-of-work-pattern.aspx.html" class="Selected">NHibernate and the Unit of Work Pattern</a></li><li><a href="../../identity-field-equality-and-hash-code.aspx.html">Identity Field, Equality and Hash Code</a></li></ul></div>
				        </div>
				        
			        </div>
	            
	    
	        
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Tags</h4>
	                    <div class="CommonContentBoxContent">
	            <ul class="CommonSidebarTagCloud">
<li class="CommonTag2"><a href="../../tags/Architecture/default.aspx.html" rel="tag">Architecture</a></li>
<li class="CommonTag6"><a href="../../tags/Audit/default.aspx.html" rel="tag">Audit</a></li>
<li class="CommonTag6"><a href="../../tags/Concurrency/default.aspx.html" rel="tag">Concurrency</a></li>
<li class="CommonTag6"><a href="../../tags/Configuration/default.aspx.html" rel="tag">Configuration</a></li>
<li class="CommonTag6"><a href="../../tags/convention+over+configuration/default.aspx.html" rel="tag">convention over configuration</a></li>
<li class="CommonTag6"><a href="../../tags/Conversation/default.aspx.html" rel="tag">Conversation</a></li>
<li class="CommonTag6"><a href="../../tags/entity+name/default.aspx.html" rel="tag">entity name</a></li>
<li class="CommonTag3"><a href="../../tags/events/default.aspx.html" rel="tag">events</a></li>
<li class="CommonTag6"><a href="../../tags/Filters/default.aspx.html" rel="tag">Filters</a></li>
<li class="CommonTag2"><a href="../../tags/FluentNH/default.aspx.html" rel="tag">FluentNH</a></li>
<li class="CommonTag6"><a href="../../tags/IIdentifierGenerator/default.aspx.html" rel="tag">IIdentifierGenerator</a></li>
<li class="CommonTag6"><a href="../../tags/Interceptor/default.aspx.html" rel="tag">Interceptor</a></li>
<li class="CommonTag6"><a href="../../tags/IoC+container/default.aspx.html" rel="tag">IoC container</a></li>
<li class="CommonTag2"><a href="../../tags/IUserType/default.aspx.html" rel="tag">IUserType</a></li>
<li class="CommonTag3"><a href="../../tags/lazy+loading/default.aspx.html" rel="tag">lazy loading</a></li>
<li class="CommonTag6"><a href="../../tags/listener/default.aspx.html" rel="tag">listener</a></li>
<li class="CommonTag6"><a href="../../tags/log/default.aspx.html" rel="tag">log</a></li>
<li class="CommonTag6"><a href="../../tags/logging/default.aspx.html" rel="tag">logging</a></li>
<li class="CommonTag1"><a href="../../tags/Mapping/default.aspx.html" rel="tag">Mapping</a></li>
<li class="CommonTag6"><a href="../../tags/Mapping+by+code/default.aspx.html" rel="tag">Mapping by code</a></li>
<li class="CommonTag1"><a href="../../tags/Nhibernate/default.aspx.html" rel="tag">Nhibernate</a></li>
<li class="CommonTag6"><a href="../../tags/Nhibernate+Documentation/default.aspx.html" rel="tag">Nhibernate Documentation</a></li>
<li class="CommonTag3"><a href="../../tags/property/default.aspx.html" rel="tag">property</a></li>
<li class="CommonTag2"><a href="../../tags/query/default.aspx.html" rel="tag">query</a></li>
<li class="CommonTag1"><a href="../../tags/Session/default.aspx.html" rel="tag">Session</a></li>
</ul>

				        </div>
				        <div class="CommonContentBoxFooter"><a href="../../tags/default.aspx.html">View more</a></div>
			        </div>
	            
	    
	        
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Page Details</h4>
	                    <div class="CommonContentBoxContent">
	            <div class="CustomWikiPageDetailsArea"><div class="CustomWikiPageDetailsTitle">First published by:</div><div class="CustomWikiPageDetailsAvatar"><img src="../../../../resized-image.ashx/__size/50x50/__key/CommunityServer.Components.Avatars/00.00.00.21.34/4TA9FMIYGIH8.jpg" alt="" style="border-width:0px;" /></div><div class="CustomWikiPageDetailsContent"><a href="../../../../members/gabriel.schenker/default.aspx.html">gabriel.schenker</a><br/> on 09-23-2008</div></div><div class="CustomWikiPageDetailsArea"><div class="CustomWikiPageDetailsTitle">Last revision by:</div><div class="CustomWikiPageDetailsAvatar"><img src="../../../../resized-image.ashx/__size/50x50/__key/CommunityServer.Components.Avatars/00.00.00.21.34/4TA9FMIYGIH8.jpg" alt="" style="border-width:0px;" /></div><div class="CustomWikiPageDetailsContent"><a href="../../../../members/gabriel.schenker/default.aspx.html">gabriel.schenker</a><br/> on 09-23-2008</div></div><div class="WikiPageDetailsSummaryArea"><strong>11</strong> people found this article useful.</div>
				        </div>
				        
			        </div>
	            
	    
	    
	    
    </div>
    

			    </div>
                <div id="CommonSidebarLeft">
				    
				</div>
			    <div id="CommonContent"><div id="CommonContentInner">
    



<div class="CommonContentBox">
    <div class="CommonContentBoxContent">
        <div style="float: right">
            
        </div>
        
        <div class="CommonPaneTabSet">
            <div style="overflow: hidden; width: 100%;">
                <table border="0" cellpadding="0" cellspacing="0">
                <tbody>
                    <tr>
                        <td>
                            <div class="CommonPaneTab">
                                <a href="../../nhibernate-and-the-unit-of-work-pattern.aspx.html"><img align="absmiddle" border="0" src="../../../../Themes/hawaii/images/wiki/wiki-icon-article-tab.png" alt="" style="border-width:0px;" /></a>                            
                                <a href="../../nhibernate-and-the-unit-of-work-pattern.aspx.html">Article</a>
                            </div>
                        </td>
                        <td>
                            
                                    <div class="CommonPaneTab">
                                    
                                    
                                    </div>
                                
                        </td>
                        <td>
                            <div class="CommonPaneTab">
                                <a href="../comments.aspx.html"><img align="absmiddle" border="0" src="../../../../Themes/hawaii/images/wiki/wiki-icon-comment-tab.png" alt="" style="border-width:0px;" /></a>
                                <a href="../comments.aspx.html">Comments</a> (18)
                            </div>
                        </td>
                        <td>
                            <div class="CommonPaneTabSelected">
                                <a href="../history.aspx.html"><img align="absmiddle" border="0" src="../../../../Themes/hawaii/images/wiki/wiki-icon-history-tab.png" alt="" style="border-width:0px;" /></a>
                                <a href="../history.aspx.html">History</a> (3)
                            </div>
                        </td>
                    </tr>
                </tbody>
                </table>
            </div>
        </div>

        <div class="CommonPane">
            <div class="CommonGroupedContentArea">
                <h2 class="CommonContentBoxHeaderSmall"><span><a href="../../nhibernate-and-the-unit-of-work-pattern.aspx.html">NHibernate and the Unit of Work Pattern</a></span></h2>
                <div><h2>Introduction</h2>
<p>Martin Fowler <a href="http://martinfowler.com/eaaCatalog/unitOfWork.html">writes</a>: </p>
<p>&quot;When you&#39;re pulling data in and out of a database, it&#39;s important to keep 
track of what you&#39;ve changed; otherwise, that data won&#39;t be written back into 
the database. Similarly you have to insert new objects you create and remove any 
objects you delete.&quot;</p>
<p>and</p>
<p>&quot;A <strong>Unit of Work</strong> keeps track of everything you do during a 
<em>business transaction</em> that can affect the database. When you&#39;re done, it 
figures out everything that needs to be done to alter the database as a result 
of your work.&quot;</p>
<p>In NHibernate we have the <strong>Session</strong> object which is a Unit of 
Work (UoW) container. The session object keeps track of all objects you load, 
new objects you add, existing objects you delete and changes you make to any of 
these objects. Only when <strong>flushing</strong> the session will the database 
be altered (that is: will the necessary create, update and delete statements be 
sent to the database).</p>
<p>Now, working directly with the NHibernate session object makes absolute 
sense. But some times you rather want to abstract the data manipulation 
interface from a specific infrastructure implementation &agrave; la NHibernate.</p>
<p><strong>Note</strong>: most of the design ideas and implementation details 
presented here originate from <a href="http://www.ayende.com/">Ayende</a>&#39;s 
UnitOfWork implemented in the <strong>Rhino.Commons</strong> which you can get 
<a href="http://rhino-tools.svn.sourceforge.net/svnroot/rhino-tools/trunk">here</a>.</p>
<h2>Design and Implementation (TDD)</h2>
<h3>Some thought about TDD</h3>
<p>I want to implement a UnitOfWork pattern for NHibernate and I want to do it 
by using <a href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a>. 
For a beginner (like I was myself not so long ago) it seems unnatural at the 
beginning. We introduce a huge overhead you might think. You might also think 
that we have to write at least double the code as when doing the development 
without TDD. But wait until you have to start to debug your application... or 
until the customer wants to have something changed in the application... or 
until you have to re-factor you application... Then you will immediately see and 
feel the benefits of a good test coverage.</p>
<h3>Attention: Multi-Threading ahead</h3>
<p>Please not that the implementation presented here is strictly 
<strong>NOT</strong> thread safe!!! I want to reduce the complexity of this 
first implementation. But <strong>I promise</strong> that in a following post 
I&#39;ll show you how to make the implementation of the unit of work pattern thread 
safe and thus useful for e.g. Web scenarios.</p>
<h3>The UnitOfWork Class</h3>
<p>To start with: I want to have an easy way to <strong>start</strong> a new 
UoW, in any place of my application have access to the <strong>current</strong> 
UoW and <strong>commit</strong> the <em>business transaction</em> represented by 
my UoW. We can do this with a static class called UnitOfWork</p>
<p><a><img style="border-width:0px;" alt="image" border="0" height="179" width="471" /></a></p>
<p>The method start creates and returns an instance of a 
<strong>UnitOfWorkImplementor</strong> class which implements the interface 
<strong>IUnitOfWork</strong>. As you can see then interface IUnitOfWork inherits 
from IDisposable. So we can define that the <em>business transaction</em> is 
ended when the UoW is disposed. Now, if we do nothing else then nothing should 
happen, that is no changes should be propagated to the database. To commit a 
<em>business transaction</em> we have to explicitly call a method of the UoW. 
Let&#39;s call this method <strong>TransactionalFlush</strong>. In doing so all 
changes recorded by the UoW are committed to the database in one go.</p>
<p>Now let&#39;s start to implement this! We are doing TDD, aren&#39;t we? So we will 
write our first test (if you are not sure how to best setup a new solution for 
TDD please consult <a href="http://blogs.hibernatingrhinos.com/nhibernate/archive/2008/04/06/how-to-setup-a-new-solution.aspx">this</a> 
post). I define a new solution with two projects as follows</p>
<p><a><img style="border-width:0px;" alt="image" border="0" height="135" width="304" /></a></p>
<p>Add a class UnitOfWork_Fixture.cs to the test project and implement the first 
test like this</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">[TestFixture]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> UnitOfWork_Fixture</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">readonly</span> MockRepository _mocks = <span style="color:#0000ff;">new</span> MockRepository();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    [Test]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_Start_UnitOfWork()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        IUnitOfWork uow = UnitOfWork.Start();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">}</pre>
</div>
</div>
<p>Of course this test will not compile since you don&#39;t have the types 
UnitOfWork and IUnitOfWork defined yet. Let <a href="http://www.jetbrains.com/resharper/">Resharper</a> create them for you (or 
implement them by hand)</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">class</span> UnitOfWork</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> IUnitOfWork Start()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> NotImplementedException();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> IUnitOfWork Current { get; <span style="color:#0000ff;">private</span> set; }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">}</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">interface</span> IUnitOfWork : IDisposable</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">}</pre>
</div>
</div>
<p>Now the test will compile but it will fail! Of course, you haven&#39;t 
implemented the Start method so far. In this method we must now create a new UoW 
and return it to the caller. A UoW is a complex beast and should therefore be 
constructed in a factory. So let&#39;s define a factory Interface IUnitOfWorkFactory 
with a method Create which returns a UoW implementing the interface 
IUnitOfWork.</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">interface</span> IUnitOfWorkFactory</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">  IUnitOfWork Create();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">}</pre>
</div>
</div>
<p>since we want to test our UnitOfWork class in isolation we have to mock all 
other dependencies line the unit of work factory. I&#39;ll use 
<strong>Rhino.Mocks</strong> as my mocking framework (Please refer to 
documentation <a href="http://www.ayende.com/wiki/Rhino+Mocks+Documentation.ashx">here</a>). I 
want to test that when calling the start method of the UnitOfWork class the 
factory gets called. So I extend my test function</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">[Test]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_Start_UnitOfWork()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    var factory = _mocks.DynamicMock&lt;IUnitOfWorkFactory&gt;();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    var unitOfWork = _mocks.DynamicMock&lt;IUnitOfWork&gt;();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    <span style="color:#008000;">// brute force attack to set my own factory via reflection</span></pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    var fieldInfo = <span style="color:#0000ff;">typeof</span>(UnitOfWork).GetField(<span style="color:#006080;">&quot;_unitOfWorkFactory&quot;</span>, </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        BindingFlags.Static | BindingFlags.SetField | BindingFlags.NonPublic);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    fieldInfo.SetValue(<span style="color:#0000ff;">null</span>, factory);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">using</span>(_mocks.Record())</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">        Expect.Call(factory.Create()).Return(unitOfWork);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">using</span>(_mocks.Playback())</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">        var uow = UnitOfWork.Start();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">}</pre>
</div>
</div>
<p>In the first two lines of code I mock the external dependencies of the 
UnitOfWork class. Then I do something you should not do very often (but I have 
good reasons doing so here and I promise it&#39;s the only time I&#39;ll do it in this 
project...). I set a private field of the UnitOfWork class with a value by using 
reflection. I could implement a public setter in the class but as I would only 
need it for this test and I want to keep the class interface as simple as 
possible I chose to do it via reflection.</p>
<p>In the&nbsp; record phase I define my expectation (namely that the factory create 
method is called) and in the playback phase I invoke the Start method which I 
want to test. The test will compile but fail to execute. I have not yet defined 
the private static field _unitOfWorkFactory and I also do not call the factory. 
So let&#39;s modify our code...</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">class</span> UnitOfWork</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">static</span> IUnitOfWorkFactory _unitOfWorkFactory;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">static</span> IUnitOfWork _innerUnitOfWork;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> IUnitOfWork Start()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">        _innerUnitOfWork = _unitOfWorkFactory.Create();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        <span style="color:#0000ff;">return</span> _innerUnitOfWork;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> IUnitOfWork Current { get; <span style="color:#0000ff;">private</span> set; }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">}</pre>
</div>
</div>
<p>now the test will pass.</p>
<p>Since in all our test regarding the UnitOfWork class we will always need it 
with an injected factory we define a new test fixture with a context setup for 
our specific needs. We put the respective code in the 
<strong>SetupContext</strong> and <strong>TearDownContext</strong> methods</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">[TestFixture]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> UnitOfWork_With_Factory_Fixture</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">readonly</span> MockRepository _mocks = <span style="color:#0000ff;">new</span> MockRepository();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    <span style="color:#0000ff;">private</span> IUnitOfWorkFactory _factory;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">private</span> IUnitOfWork _unitOfWork;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    [SetUp]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> SetupContext()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        _factory = _mocks.DynamicMock&lt;IUnitOfWorkFactory&gt;();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">        _unitOfWork = _mocks.DynamicMock&lt;IUnitOfWork&gt;();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">        <span style="color:#008000;">// brute force attack to set my own factory via reflection</span></pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        var fieldInfo = <span style="color:#0000ff;">typeof</span>(UnitOfWork).GetField(<span style="color:#006080;">&quot;_unitOfWorkFactory&quot;</span>,</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">            BindingFlags.Static | BindingFlags.SetField | BindingFlags.NonPublic);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        fieldInfo.SetValue(<span style="color:#0000ff;">null</span>, _factory);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        _mocks.BackToRecordAll();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">        SetupResult.For(_factory.Create()).Return(_unitOfWork);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        _mocks.ReplayAll();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    [TearDown]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> TearDownContext()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        _mocks.VerifyAll();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">}</pre>
</div>
</div>
<p><strong>Note</strong>: in the second last line of the 
<strong>SetupContext</strong> method we define that each time the method Create 
of the factory object is called (by the UnitOfWork Start method) we want it to 
return our predefined mocked _<strong>unitOfWork</strong> instance.</p>
<p>Trying to start a UoW if there is already one active should throw a 
meaningful exception. This is the test</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">[Test]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Starting_UnitOfWork_if_already_started_throws()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    UnitOfWork.Start();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    <span style="color:#0000ff;">try</span></pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        UnitOfWork.Start();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    <span style="color:#0000ff;">catch</span> (InvalidOperationException ex)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    { }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">}</pre>
</div>
</div>
<p>As a consequence we have to extend our Start method in the UnitOfWork 
class</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> IUnitOfWork Start()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    <span style="color:#0000ff;">if</span> (_innerUnitOfWork != <span style="color:#0000ff;">null</span>)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> InvalidOperationException(<span style="color:#006080;">&quot;You cannot start more than one unit of work at the same time.&quot;</span>);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    _innerUnitOfWork = _unitOfWorkFactory.Create();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    <span style="color:#0000ff;">return</span> _innerUnitOfWork;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">}</pre>
</div>
</div>
<p>Now I have another problem: After the test is finished the static field 
_<strong>innerUnitOfWork</strong> of my <strong>UnitOfWork</strong> class is set 
to a value other than <strong>null</strong>. This will have a undesired side 
effect to the following test. I have to reset this field. Again in this special 
case I&#39;ll do it via reflection to not clutter the interface of my class (static 
classes are difficult more complex to deal with in TDD than non static 
classes...). We do reset our UnitOfWork class in the TearDownContext method</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">[TearDown]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> TearDownContext()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    _mocks.VerifyAll();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#008000;">// assert that the UnitOfWork is reset</span></pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    var fieldInfo = <span style="color:#0000ff;">typeof</span>(UnitOfWork).GetField(<span style="color:#006080;">&quot;_innerUnitOfWork&quot;</span>,</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">        BindingFlags.Static | BindingFlags.SetField | BindingFlags.NonPublic);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    fieldInfo.SetValue(<span style="color:#0000ff;">null</span>, <span style="color:#0000ff;">null</span>);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">}</pre>
</div>
</div>
<p>Next we want to be able to access the current unit of work. As usual we first 
implement a test</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">[Test]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_access_current_unit_of_work()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    IUnitOfWork uow = UnitOfWork.Start();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    var current = UnitOfWork.Current;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    Assert.AreSame(uow, current);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">}</pre>
</div>
</div>
<p>You can figure out what code you need to implement for the test to pass.</p>
<p>We also want to assert that when accessing the current UoW if no UoW has been 
started that a meaningful exception is thrown</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">[Test]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Accessing_Current_UnitOfWork_if_not_started_throws()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">try</span></pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">        var current = UnitOfWork.Current;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">catch</span> (InvalidOperationException ex)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    { }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">}</pre>
</div>
</div>
<p>now my implementation of the Current property in the UnitOfWork class is as 
follows</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> IUnitOfWork Current</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    get</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        <span style="color:#0000ff;">if</span> (_innerUnitOfWork == <span style="color:#0000ff;">null</span>)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">            <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> InvalidOperationException(<span style="color:#006080;">&quot;You are not in a unit of work.&quot;</span>);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        <span style="color:#0000ff;">return</span> _innerUnitOfWork;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">}</pre>
</div>
</div>
<p>Next we want a property on the class which tells us whether a UoW is started 
or not. The test for it</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">[Test]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_test_if_UnitOfWork_Is_Started()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    Assert.IsFalse(UnitOfWork.IsStarted);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    IUnitOfWork uow = UnitOfWork.Start();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    Assert.IsTrue(UnitOfWork.IsStarted);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">}</pre>
</div>
</div>
<p>It&#39;s getting boring isn&#39;t it... But this is the way <strong>TDD</strong> 
works. You always think (hard) on what you need and then you implement the test 
with which you can proof that you get it as you want it. Only then you implement 
the functionality needed to fulfill the test. If you do so you automatically 
follow the <strong>YAGNI</strong> principle (you ain&#39;t gona need it) that is you 
only implement the code you really need!</p>
<p>We can fulfill the test like so</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">bool</span> IsStarted</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    get { <span style="color:#0000ff;">return</span> _innerUnitOfWork != <span style="color:#0000ff;">null</span>; }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">}</pre>
</div>
</div>
<p>The UnitOfWork class is now a perfect wrapper for the NHibernate session 
object. Though for some advance scenarios I would like to have access to the 
session object related to my UoW. As a consequence I&#39;ll implement a read only 
property CurrentSession in the UnitOfWork class. Lets again start with the 
test</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">[Test]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_get_valid_current_session_if_UoW_is_started()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">using</span> (UnitOfWork.Start())</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">        ISession session = UnitOfWork.CurrentSession;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">        Assert.IsNotNull(session);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">}</pre>
</div>
</div>
<p>and the implementation</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> ISession CurrentSession</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    get { <span style="color:#0000ff;">return</span> _unitOfWorkFactory.CurrentSession; }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">internal</span> set { _unitOfWorkFactory.CurrentSession = <span style="color:#0000ff;">value</span>; }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">}</pre>
</div>
</div>
<p>Note that I have just delegated the call to the factory class. Thus to make 
the test pass I have to add two additional lines to the SetupContext method of 
the test fixture where I mock a session object and setup the result for a call 
to the property CurrentSession of the factory.</p>
<div>
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">[SetUp]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> SetupContext()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    _factory = _mocks.DynamicMock&lt;IUnitOfWorkFactory&gt;();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    _unitOfWork = _mocks.DynamicMock&lt;IUnitOfWork&gt;();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    _session = _mocks.DynamicMock&lt;ISession&gt;();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    <span style="color:#008000;">// brute force attack to set my own factory via reflection</span></pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    var fieldInfo = <span style="color:#0000ff;">typeof</span>(UnitOfWork).GetField(<span style="color:#006080;">&quot;_unitOfWorkFactory&quot;</span>,</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">        BindingFlags.Static | BindingFlags.SetField | BindingFlags.NonPublic);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    fieldInfo.SetValue(<span style="color:#0000ff;">null</span>, _factory);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">&nbsp;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    _mocks.BackToRecordAll();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    SetupResult.For(_factory.Create()).Return(_unitOfWork);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">    SetupResult.For(_factory.CurrentSession).Return(_session);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:#f4f4f4;">    _mocks.ReplayAll();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,&#39;Courier New&#39;,courier,monospace;background-color:white;">}</pre>
</div>
</div>
<p>That&#39;s all we need for the moment regarding the UnitOfWork class. Next topics 
will be the the implementation of the UnitOfWorkFactory class and then of the 
UnitOfWorkImplementor class. The details will be presented in the next post to 
this blog. So keep ready...</p>
<p>&nbsp;</p>
<p>Part 2</p>
<h2>Design and Implementation</h2>
<h3>The Unit Of Work Factory</h3>
<p>The creation of a unit of work instance is a complex process and as such is a 
good candidate for a factory.</p>
<p>Since a UoW (Unit of Work) is basically a wrapper around a NHibernate session 
object I&#39;ll need to open such a session whenever I start a new UoW. But to be 
able to get such a session NHibernate has to be configured and a NHibernate 
Session Factory has to be available. The interface of my UoW factory is defined 
as follows</p>
<p><a><img style="border-width:0px;" alt="image" border="0" height="236" width="214" /></a> </p>
<p>&nbsp;</p>
<p>&nbsp;</p></div>
            </div>
        </div>

    </div>
</div>


</div></div>
			    <div style="clear: both;"></div>
			    
			    
            </div>
                
            <div id="CommonFooter">
                <div class="Common">
                    
                        
                	    
                        

                        
                                <a href="http://communityserver.com/" target="_blank"><img src="../../../../utility/PoweredByCS_commercial.gif" alt="Powered by Community Server (Commercial Edition), by Telligent Systems " style="border-width:0px;" /></a>
		                    
                		
                    
                 </div>
            </div>
		
<script type="text/javascript">
// <![CDATA[
Telligent_Modal.Configure('/utility/loading.htm',['CommonModal'],['CommonModalTitle'],['CommonModalClose'],['CommonModalContent'],['CommonModalFooter'],['CommonModalResize'],['CommonModalMask'],100,false,true);
// ]]>
</script><script type="text/javascript">
<!--
function KeyDownHandlerctl00_ctl00_sr_sr_ctl00_ctl00_TitleBarSearchButton(event)
{
	if (event.keyCode == 13)
	{
		event.returnValue = false;
		event.cancel = true;
     __doPostBack('ctl00$ctl00$sr$sr$ctl00$ctl00$TitleBarSearchButton','')
   return false;
	}
}

//-->
</script>
<script type="text/javascript">
// <![CDATA[
window.ctl00_ctl00_rcr_rcr_ctl00_ctl02_ctl00_ctl01_ctl01=new WikiPageHierarchy('ctl00_ctl00_rcr_rcr_ctl00_ctl02_ctl00_ctl01_ctl01',new Function('mode','pageId','callback','WebForm_DoCallback(\'ctl00$ctl00$rcr$rcr$ctl00$ctl02$ctl00$ctl01$ctl01\',mode + \':\' + pageId,callback,\"\",null,false)'),'<img src="http://nhforge.org/wikis/patternsandpractices/nhibernate-and-the-unit-of-work-pattern/revision/\&quot;/WebResource.axd?d=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000\&quot;" alt=\"+\" style=\"border-width: 0;\" />','<img src="http://nhforge.org/wikis/patternsandpractices/nhibernate-and-the-unit-of-work-pattern/revision/\&quot;/WebResource.axd?d=I7Z2L5Ca7ffItUeObf-LA3ykZ3Mbmr-vwfNJv2PfNk2O4alHWIJbJADyKhl0k71mJCpGTePjifKqZQx_Rs64LrGhlEU25qRjlCh8LoYwo2tck8EIbBdQKg5CISopk9hz_6ZbK_GNtBJljwOq57_FBvxYCTM1&amp;t=634395149500000000\&quot;" alt=\"-\" style=\"border-width: 0;\" />','<div>Loading...</div>');
// ]]>
</script><script type="text/javascript">
// <![CDATA[
window.ctl00_ctl00_rcr_rcr_ctl00_ctl03_ctl00_ctl01_ctl01=new WikiPageHierarchy('ctl00_ctl00_rcr_rcr_ctl00_ctl03_ctl00_ctl01_ctl01',new Function('mode','pageId','callback','WebForm_DoCallback(\'ctl00$ctl00$rcr$rcr$ctl00$ctl03$ctl00$ctl01$ctl01\',mode + \':\' + pageId,callback,\"\",null,false)'),'<img src="http://nhforge.org/wikis/patternsandpractices/nhibernate-and-the-unit-of-work-pattern/revision/\&quot;/WebResource.axd?d=sNXLzaCqbYO_a-ZjCZB88HF4WT8YRbuRaD2xfyafsCiRqelSVt4GYH9QzNn_EvXM02V5zpjGwsymzmW30OIrbB4EUeqA1XW4oU6sME2qMEcOgSVpfz1_YK7UdKB8bVtbFiuWJt3UljrDk5OnRzQEWKDyXNGX0R6sJsultQeBjufuUDz-0&amp;t=634395149500000000\&quot;" alt=\"+\" style=\"border-width: 0;\" />','<img src="http://nhforge.org/wikis/patternsandpractices/nhibernate-and-the-unit-of-work-pattern/revision/\&quot;/WebResource.axd?d=I7Z2L5Ca7ffItUeObf-LA3ykZ3Mbmr-vwfNJv2PfNk2O4alHWIJbJADyKhl0k71mJCpGTePjifKqZQx_Rs64LrGhlEU25qRjlCh8LoYwo2tck8EIbBdQKg5CISopk9hz_6ZbK_GNtBJljwOq57_FBvxYCTM1&amp;t=634395149500000000\&quot;" alt=\"-\" style=\"border-width: 0;\" />','<div>Loading...</div>');
// ]]>
</script><script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-5443308-1");
pageTracker._trackPageview();
</script></form>
		
	</body>
</html>
