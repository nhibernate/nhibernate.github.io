---
layout: doc
title: Your first NHibernate based application
---
                <div id="CommonNavigationShadow">
                    
    
    <div class="CommonBreadCrumbArea"><div class="Common">
        <a href="../../index.html">Documentation</a>
        »
        <a href="your-first-nhibernate-based-application.html">Your first NHibernate based application</a>
    </div></div>


                </div>
		    
                        
            <div class="Common">
            
                
            
                
                <div id="CommonTitle">
                    
    
    <h1>Your first NHibernate based application</h1>


                <div class="CommonByline">
<span>This page is converted from the old nhforge.org Wiki.</span> <span class="revision">First published by: <span class="author">Fabio Maulo on 09-16-2008</span></span>, <span class="revision">Last revision by: <span class="author">mStyle on 04-16-2011</span></span>
</div>
</div>
        <div style="clear: both;"></div>
        <div id="CommonSidebarRight">
            <div class="CommonSidebar">
                <div class="CommonContentBox">
                    {% include google_adsense.html %}
                </div>
            </div>  
        </div>
        <div id="CommonSidebarLeft">
        </div>
                
			    <div id="CommonContent"><div id="CommonContentInner">
    



<div class="CommonContentBox">
    <div class="CommonContentBoxContent">
        <div style="float: right">
            
        </div>
        
        

        
            <div class="CommonGroupedContentArea">                

                

                <h2 class="">
                        <span><a href="your-first-nhibernate-based-application.html">Your first NHibernate based application</a></span>
                        
                    </h2>
                                
                
                <div>
<p><strong><span style="color:#ff8000;">Wiki extracted from the original blog post of Gabriel Schenker</span></strong></p>
<h4>Welcome to NHibernate</h4>
<p>If you're reading this, we assume that you've just <a href="http://sourceforge.net/projects/nhibernate/files/NHibernate/">downloaded NHibernate</a> or installed it from <a href="https://nuget.org/packages/NHibernate">NuGet</a> and want to get started using it.</p>
<p>This tutorial will talk you through the following:</p>
<ul>
<li>Installing NHibernate</li>
<li>Defining a simple business object class.</li>
<li>Create an NHibernate mapping to load and save the business object.</li>
<li>Configure NHibernate to talk to your local database.</li>
<li>Automatically generate a database </li>
<li>Writing simple CRUD code using the Repository pattern.</li>
<li>Using Unit Tests to make sure the code is working correctly.</li>
</ul>
<p>This is what we're aiming for:</p>
<p style="padding-left:150px;"><img src="solutionex.png" alt=""></p>
<p> </p>
<p>But first things first [:)]</p>
<p>Lets start by actually doing something with that ZIP file you just downloaded.</p>
<h4><b><b>Installing NHibernate</b></b></h4>
<p>If you've downloaded the NHibernate binaries in a zip file, all you need to do is extract that file to somewhere sensible. I usually create a folder called SharedLibs  <code>c:\Code\SharedLibs\NHibernate</code> and extract the zip to there. But whatever you're comfortable with. This is your SharedLib folder from which you need to add your references to the NHibernate and NUnit dlls. Add references to NHibernate to both the demo project and the unit test project.</p>
<p>That's it! NHibernate is installed (easy huh). We'll talk you through using it with Visual Studio in a moment. First let's look at how we go about creating a project. Note this code is dependent on Visual Studio 2008 and .Net Framework 3.5.</p>
<h4><b><b>Create Your Project</b></b></h4>
<p>Before we start building our application and business objects, we'll need to create a blank project to put them in. Fire up Visual Studio and create a new Class Library project. Let's now look at something interesting: creating a business object.</p>
<h4><b>Defining the Business Objects<br></b></h4>
<p>Lets start by defining a very simple domain. For the moment it consists of one entity called <b>Product</b>. The product has 3 properties Name, Category and Discontinued.</p>
<p style="padding-left:210px;"><img src="ProductDef.png" alt=""></p>
<p>Add a folder Domain to the FirstSample project of your solution. Add a new class <b>Product.cs</b> to this folder. The code is very simple and uses automatic properties (a feature of the new C# 3.0 compiler) </p>
<div>
<div>
<div>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">namespace</span> FirstSolution.Domain<br>{<br>    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> Product<br>    {<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">string</span> Name { get; set; }<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">string</span> Category { get; set; }<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">bool</span> Discontinued { get; set; }<br>    }<br>}</pre>
</div>
</div>
</div>
<p>Now we want to be able to persist instances of this entity in a (relational) database. We have chosen <b>NHibernate</b>for this task. An instance of an entity in the domain corresponds to a <b>row in a table</b> in the database. So we have to define a mapping between the entity and the corresponding table in the database. This mapping can be done either by defining a mapping file (an xml-document) or by decorating the entity with attributes. I'll start with the mapping file.</p>
<h4><b>Define the Mapping</b></h4>
<p>Create a folder <b>Mappings</b> in the FirstSample project. Add a new xml-document to this folder and call it <b><b>Product</b>.hbm.xml</b>. Please note the "hbm" part of the file name. This is a convention used by NHibernate to automatically recognize the file as a mapping file. Define "Embedded Resource" as <b>Build Action</b> for this xml file.</p>
<p>In the Windows Explorer locate the nhibernate-mapping.xsd in the src folder of NHibernate and copy it to your SharedLibs folder. We can now use this xml schema definition file when defining our mapping files. VS will then provide intellisense and validation when editing an xml mapping document.</p>
<p>Back in VS add the schema to the Product.hbm.xml file</p>
<p><img src="properties.png" alt=""></p>
<p>Let's start now. Each mapping file has to define a &lt;hibernate-mapping&gt; root node</p>
<div class="wlWriterSmartContent" id="scid:F2210F5F-69EB-4d4c-AFF7-B8A050E9CC72:73647d35-a397-46d8-ad1c-a9edf8bbe509">
<p> </p>
<div>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">&lt;?</span><span style="color:#800000;">xml</span> <span style="color:#ff0000;">version</span><span style="color:#0000ff;">="1.0"</span> <span style="color:#ff0000;">encoding</span><span style="color:#0000ff;">="utf-8"</span> ?<span style="color:#0000ff;">&gt;</span><br><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">hibernate-mapping</span> <span style="color:#ff0000;">xmlns</span><span style="color:#0000ff;">="urn:nhibernate-mapping-2.2"</span> <br>                   <span style="color:#ff0000;">assembly</span><span style="color:#0000ff;">="FirstSolution"</span> <br>                   <span style="color:#ff0000;">namespace</span><span style="color:#0000ff;">="FirstSolution.Domain"</span><span style="color:#0000ff;">&gt;</span><br> <br>  <span style="color:#008000;">&lt;!-- more mapping info here --&gt;</span><br>  <br><span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">hibernate-mapping</span><span style="color:#0000ff;">&gt;</span></pre>
</div>
<div></div>
<div>In a mapping file when referencing a domain class you always have to provide the fully qualified name of the class (e.g. FirstSample.Domain.Product, FirstSample). To make the xml less verbose you can define the assembly name (in which the domain classes are implemented and the namespace of the domain classes in the two attributes <b>assembly</b> and <b>namespace</b> of the root node. It's similar to the <b>using</b> statement in C#.</div>
<p> </p>
</div>
<p>Now we have to first define a <b>primary key</b> for the product entity. Technically we could take the property <b>Name</b> of the product since this property must be defined and has to be unique. But it is common to use a surrogate key instead. For thus we add a property to our entity and call it <b>Id</b>. We use <b>Guid</b> as the type of the Id but it can as well be an int or a long.</p>
<div>
<div>
<div>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">using</span> System;<br> <br><span style="color:#0000ff;">namespace</span> FirstSolution.Domain<br>{<br>    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> Product<br>    {<br>        <span style="color:#0000ff;">public</span> Guid Id { get; set; }<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">string</span> Name { get; set; }<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">string</span> Category { get; set; }<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">bool</span> Discontinued { get; set; }<br>    }<br>}</pre>
</div>
</div>
</div>
<p>The complete mapping file</p>
<div>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">&lt;?</span><span style="color:#800000;">xml</span> <span style="color:#ff0000;">version</span><span style="color:#0000ff;">="1.0"</span> <span style="color:#ff0000;">encoding</span><span style="color:#0000ff;">="utf-8"</span> ?<span style="color:#0000ff;">&gt;</span><br><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">hibernate-mapping</span> <span style="color:#ff0000;">xmlns</span><span style="color:#0000ff;">="urn:nhibernate-mapping-2.2"</span> <br>                   <span style="color:#ff0000;">assembly</span><span style="color:#0000ff;">="FirstSolution"</span> <br>                   <span style="color:#ff0000;">namespace</span><span style="color:#0000ff;">="FirstSolution.Domain"</span><span style="color:#0000ff;">&gt;</span><br>  <br>  <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">class</span> <span style="color:#ff0000;">name</span><span style="color:#0000ff;">="Product"</span><span style="color:#0000ff;">&gt;</span><br>    <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">id</span> <span style="color:#ff0000;">name</span><span style="color:#0000ff;">="Id"</span><span style="color:#0000ff;">&gt;</span><br>      <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">generator</span> <span style="color:#ff0000;">class</span><span style="color:#0000ff;">="guid"</span> <span style="color:#0000ff;">/&gt;</span><br>    <span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">id</span><span style="color:#0000ff;">&gt;</span><br>    <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">property</span> <span style="color:#ff0000;">name</span><span style="color:#0000ff;">="Name"</span> <span style="color:#0000ff;">/&gt;</span><br>    <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">property</span> <span style="color:#ff0000;">name</span><span style="color:#0000ff;">="Category"</span> <span style="color:#0000ff;">/&gt;</span><br>    <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">property</span> <span style="color:#ff0000;">name</span><span style="color:#0000ff;">="Discontinued"</span> <span style="color:#0000ff;">/&gt;</span><br>  <span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">class</span><span style="color:#0000ff;">&gt;</span><br>  <br><span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">hibernate-mapping</span><span style="color:#0000ff;">&gt;</span></pre>
</div>
<p>NHibernate doesn't get in our way such as that it defines many reasonable defaults. So if you don't provide a column name for a property explicitly it will name the column according to the property. Or NHibernate can automatically infer the name of the table or the type of the column from the class definition. As a consequence my xml mapping file is not cluttered with redundant information. Please refer to the online documentation for more detailed explanation of the mapping. You can find it <a href="https://nhibernate.info/doc/nhibernate-reference/mapping.html">here</a>.</p>
<p>Your solution explorer should look like this now (<b>Domain.cd</b> contains the class diagram of our simple domain). You will have added the design folder and created the class diagram yourself although this is for good practice and not required for the purposes of this excercise.</p>
<p style="padding-left:150px;"><img src="solutionex.png" alt=""></p>
<h4><b>Configure NHibernate</b></h4>
<p>We now have to tell NHibernate which database product we want to use and provide it the connection details in form of a connection string. NHibernate supports many many database products!</p>
<p>Add a new xml file to the FirstSolution project and call it hibernate.cfg.xml. Set its property "<b>Copy to Output</b>" to "<b>Copy always</b>". Since we are using SQL Server Compact Edition in this first sample enter the following information into the xml file</p>
<div>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">&lt;?</span><span style="color:#800000;">xml</span> <span style="color:#ff0000;">version</span><span style="color:#0000ff;">="1.0"</span> <span style="color:#ff0000;">encoding</span><span style="color:#0000ff;">="utf-8"</span> ?<span style="color:#0000ff;">&gt;</span><br><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">hibernate-configuration</span> <span style="color:#ff0000;">xmlns</span><span style="color:#0000ff;">="urn:nhibernate-configuration-2.2"</span><span style="color:#0000ff;">&gt;</span><br>  <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">session-factory</span><span style="color:#0000ff;">&gt;</span><br>    <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">property</span> <span style="color:#ff0000;">name</span><span style="color:#0000ff;">="connection.provider"</span><span style="color:#0000ff;">&gt;</span>NHibernate.Connection.DriverConnectionProvider<span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000ff;">&gt;</span><br>    <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">property</span> <span style="color:#ff0000;">name</span><span style="color:#0000ff;">="dialect"</span><span style="color:#0000ff;">&gt;</span>NHibernate.Dialect.MsSqlCeDialect<span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000ff;">&gt;</span><br>    <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">property</span> <span style="color:#ff0000;">name</span><span style="color:#0000ff;">="connection.driver_class"</span><span style="color:#0000ff;">&gt;</span>NHibernate.Driver.SqlServerCeDriver<span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000ff;">&gt;</span><br>    <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">property</span> <span style="color:#ff0000;">name</span><span style="color:#0000ff;">="connection.connection_string"</span><span style="color:#0000ff;">&gt;</span>Data Source=FirstSample.sdf<span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000ff;">&gt;</span><br>    <br>    <span style="color:#0000ff;">&lt;</span><span style="color:#800000;">property</span> <span style="color:#ff0000;">name</span><span style="color:#0000ff;">="show_sql"</span><span style="color:#0000ff;">&gt;</span>true<span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000ff;">&gt;</span><br>  <span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">session-factory</span><span style="color:#0000ff;">&gt;</span><br><span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">hibernate-configuration</span><span style="color:#0000ff;">&gt;</span></pre>
</div>
<p>With this configuration file we tell NHibernate that we want to use MS SQL Server Compact Edition as our target database and that the name of the database shall be FirstSample.sdf (=connection string). We have also defined that we want to see the <b>SQL</b> NHibernate generates and sends to the database (highly recommended for debugging purposes during development). Double check that you have no typos in the code!</p>
<p>Add an empty database called <b>FirstSample.sdf</b> to the FirstSample project (choose <b>Local Database</b> as template)</p>
<p><img src="AddNewItem.png" alt=""></p>
<p>Click Add and ignore the DataSet creation wizard (just hit Cancel).</p>
<h4><b>Test the Setup</b></h4>
<p>It's now time to test our setup. First verify that you have the following files in your SharedLibs folder</p>
<p style="padding-left:180px;"><img src="SharedLibs.png" alt=""></p>
<p>The last 8 files you can find in the "<b>Microsoft SQL Server Compact Edition</b>" directory in your Programs folder.</p>
<p><img src="sqlce.png" alt=""></p>
<p>Note: the <b>System.Data.SqlServerCe.dll</b> is located in the sub-folder <b>Desktop</b>.</p>
<p>All other files can be found in the NHibernate folder</p>
<p>Add a reference to the FirstSample project in your test project. Additionally add references to NHibernate.dll, nunit.framework.dll and Systm.Data.SqlServerCe.dll (remember to reference the files located in the SharedLibs folder!). Pay attention to set the property "<b>Copy Local</b>" to <b>true</b> for the assembly System.Data.SqlServerCe.dll since by default it is set to false! Add a copy of hibernate.cfg.xml to the root of this unit test project. Direct action with NHibernate in the NUnit project needs access to this file.</p>
<p>Add a class called <b>GenerateSchema_Fixture</b> to your test project. Your test project should now look like this</p>
<p style="padding-left:120px;"><img src="solutionex1.png" alt=""></p>
<p>We further need the 7 files sqce*.dll in the output directory. We can do this by using a post-build event in VS. Enter the following command in the "Post-build event command line"</p>
<p>copy $(ProjectDir)..\..\SharedLibs\sqlce*.dll $(ProjectDir)$(OutDir)</p>
<p><img src="AppProperties.png" alt=""></p>
<p>Now add the following code to the GenerateSchema_Fixture file</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;height:370px;background-color:#f4f4f4;">
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"><span style="color:#0000ff;">using</span> FirstSolution.Domain;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">using</span> NHibernate.Cfg;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"><span style="color:#0000ff;">using</span> NHibernate.Tool.hbm2ddl;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">using</span> NUnit.Framework;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">namespace</span> FirstSolution.Tests</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">    [TestFixture]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> GenerateSchema_Fixture</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        [Test]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_generate_schema()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            var cfg = <span style="color:#0000ff;">new</span> Configuration();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            cfg.Configure();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            cfg.AddAssembly(<span style="color:#0000ff;">typeof</span> (Product).Assembly);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            <span style="color:#0000ff;">new</span> SchemaExport(cfg).Execute(<span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">true</span>, <span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">false</span>);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">}</pre>
</div>
</div>
</div>
<p>The first line of the test method creates a new instance of the NHibernate configuration class. This class is used to configure NHibernate. In the second line we tell NHibernate to configure itself. NHibernate will look out for configuration information since we do not provide any information here in the test method. So NHibernate will search for a file called <b>hibernate.cfg.xml</b> in the output directory. That's exactly what we want since we have defined our settings in this file.</p>
<p>In the third line of the code we tell NHibernate that it can find mapping information in the assembly which contains also the class Product. At the time being it will only find one such file (Product.hbm.xml) as an embedded resource.</p>
<p>The fourth line of code uses the SchemaExport helper class of NHibernate to auto-"magically" generate the schema in the database for us. SchemaExport will create the product table in the database and each time you call it it will delete the table and the table data and recreate it.</p>
<p>Note: with this test method we do <b>NOT</b> want to find out whether NHibernate does its job correctly (you can be sure it does) but rater whether we have setup our system correctly. However, you can check the database and see the newly created 'product' table.</p>
<p>If you have <a href="http://www.testdriven.net/">TestDriven.Net</a> installed you can now just right click inside the test method and choose "<b>Run Test(s)</b>" to execute the test.</p>
<p style="padding-left:30px;"><img src="RunTest.png" alt=""></p>
<p>If every thing is ok you should see the following result in the output window</p>
<p style="padding-left:30px;"><img src="TestResult.png" alt=""></p>
<p>If you have <a href="http://www.jetbrains.com/resharper/">ReSharper</a> installed you can just start the test by clicking the yellow-green circle on the left border and choose <b>Run</b>.</p>
<p style="padding-left:120px;"><img src="RSTestinfo.png" alt=""></p>
<p>The result is as follows</p>
<p style="padding-left:90px;"><img src="RSRunTest.png" alt=""></p>
<h4><b>In case of Problems</b></h4>
<p>If your test fails double check that you find the following files in your target directory (that is: m:dev\projects\FirstSolution\src\FirstSolution.Tests\bin\debug)</p>
<p style="padding-left:150px;"><img src="InCaseOfPb.png" alt=""></p>
<p>Double check also if you have no typos in the NHibernate configuration file (hibernate.cfg.xml) or in the mapping file (Product.hbm.xml). Finally check whether you have set the "<b>Build Action</b>" of the mapping file (Product.hbm.xml) to "<b>Embedded Resource</b>". Only continue if the test succeeds.</p>
<h4><b>Our first CRUD operations</b></h4>
<p>Now obviously our system is ready to start. We have successfully implemented our Domain, defined the mapping files and configured NHibernate. Finally we have used NHibernate to automatically generate the database schema from our Domain (and our mapping files).</p>
<p>In the spirit of DDD (see e.g. <a href="http://domaindrivendesign.org/books/">Domain Driven Design</a> by Eric Evans) we define a repository for all crud operations (create, read, update and delete). The repository interface is part of the domain where as the implementation is not! The implementation is infrastructure specific. We want to keep our domain persistence ignorant (PI).</p>
<p>Add a new interface to the domain folder of our FirstSolution project. Call it IProductRepository. Let's define the following interface</p>
<div>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;height:269px;background-color:#f4f4f4;">
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"><span style="color:#0000ff;">using</span> System;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">using</span> System.Collections.Generic;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">namespace</span> FirstSolution.Domain</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">interface</span> IProductRepository</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">void</span> Add(Product product);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        <span style="color:#0000ff;">void</span> Update(Product product);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">void</span> Remove(Product product);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        Product GetById(Guid productId);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        Product GetByName(<span style="color:#0000ff;">string</span> name);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        ICollection&lt;Product&gt; GetByCategory(<span style="color:#0000ff;">string</span> category);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">}</pre>
</div>
</div>
</div>
</div>
<p>Add a class ProductRepository_Fixture to the test project of the solution and add the following code</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;height:270px;background-color:#f4f4f4;">
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">[TestFixture]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> ProductRepository_Fixture</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">private</span> ISessionFactory _sessionFactory;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        <span style="color:#0000ff;">private</span> Configuration _configuration;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        [TestFixtureSetUp]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> TestFixtureSetUp()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            _configuration = <span style="color:#0000ff;">new</span> Configuration();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            _configuration.Configure();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            _configuration.AddAssembly(<span style="color:#0000ff;">typeof</span> (Product).Assembly);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            _sessionFactory = _configuration.BuildSessionFactory();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">    }</pre>
</div>
</div>
</div>
<p>In the fourth line of the method TestFixtureSetUp we create a session factory. This is an expensive process and should thus be executed only once. That's the reason why I put it into this method which is only executed once during a test cycle.</p>
<p>To keep our test methods side effect free we re-create our database schema before the execution of each test method. Thus we add the following method</p>
<div>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">[SetUp]<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> SetupContext()<br>        {<br>            <span style="color:#0000ff;">new</span> SchemaExport(_configuration).Execute(<span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">true</span>, <span style="color:#0000ff;">false</span>, <span style="color:#0000ff;">false</span>);<br>        }</pre>
</div>
<p>And now we can implement the test method to add a new product instance to the database. Start by adding a new folder called Repositories to your <b>FirstSolution</b> project. Add a class <b>ProductRepository</b> to this folder. Make the<b>ProductRepository</b> inherit from the interface <b>IProductRepository</b>.</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;height:652px;background-color:#f4f4f4;">
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"><span style="color:#0000ff;">using</span> System;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">using</span> System.Collections.Generic;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"><span style="color:#0000ff;">using</span> FirstSolution.Domain;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"><span style="color:#0000ff;">namespace</span> FirstSolution.Repositories</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> ProductRepository : IProductRepository</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Add(Product product)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> NotImplementedException();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Update(Product product)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> NotImplementedException();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Remove(Product product)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> NotImplementedException();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> Product GetById(Guid productId)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> NotImplementedException();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        <span style="color:#0000ff;">public</span> Product GetByName(<span style="color:#0000ff;">string</span> name)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> NotImplementedException();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> ICollection&lt;Product&gt; GetByCategory(<span style="color:#0000ff;">string</span> category)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> NotImplementedException();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">}</pre>
</div>
</div>
</div>
<h6><b>Manipulating Data</b></h6>
<p>Now go back to the ProductRepository_Fixture test class and implement the first test method</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">      [Test]<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_add_new_product()<br>        {<br>            var product = <span style="color:#0000ff;">new</span> Product {Name = <span style="color:#006080;">"Apple"</span>, Category = <span style="color:#006080;">"Fruits"</span>};<br>            IProductRepository repository = <span style="color:#0000ff;">new</span> ProductRepository();<br>            repository.Add(product);<br>        }</pre>
</div>
</div>
<p>The first run of the test method will fail since we have not yet implemented the <b>Add</b> method in the repository class. Let's do it. <b>But wait</b>, we have to define a little helper class first which provides us session objects on demand.</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;height:523px;background-color:#f4f4f4;">
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"><span style="color:#0000ff;">using</span> FirstSolution.Domain;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"><span style="color:#0000ff;">using</span> NHibernate;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"><span style="color:#0000ff;">using</span> NHibernate.Cfg;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"><span style="color:#0000ff;">namespace</span> FirstSolution.Repositories</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">{</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> NHibernateHelper</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">    {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">static</span> ISessionFactory _sessionFactory;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">static</span> ISessionFactory SessionFactory</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            get</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                <span style="color:#0000ff;">if</span>(_sessionFactory == <span style="color:#0000ff;">null</span>)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                    var configuration = <span style="color:#0000ff;">new</span> Configuration();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                    configuration.Configure();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                    configuration.AddAssembly(<span style="color:#0000ff;">typeof</span>(Product).Assembly);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                    _sessionFactory = configuration.BuildSessionFactory();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                <span style="color:#0000ff;">return</span> _sessionFactory;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">static</span> ISession OpenSession()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            <span style="color:#0000ff;">return</span> SessionFactory.OpenSession();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">    }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">}</pre>
</div>
</div>
</div>
<p>This class creates a session factory only the first time a client needs a new session.</p>
<p>Now we can define the Add method in the ProductRepository as follows</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"> <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Add(Product product)<br>        {<br>            <span style="color:#0000ff;">using</span> (ISession session = NHibernateHelper.OpenSession())<br>                <span style="color:#0000ff;">using</span> (ITransaction transaction = session.BeginTransaction())<br>                {<br>                    session.Save(product);<br>                    transaction.Commit();<br>                }<br>        }</pre>
</div>
</div>
<p>The second run of the test method will again fail with the following message</p>
<p><img src="ShouldBeVirtual.png" alt=""></p>
<p>That's because NHibernate is by default configured to use<b> <a href="http://martinfowler.com/eaaCatalog/lazyLoad.html">lazy load</a></b> for all entities. That is the recommended approach and I warmly recommend not to change it for a maximum of flexibility.</p>
<p>How can we solve this issue? It's easy we have to just make all our properties (and methods) of the domain object(s) virtual. Let's do this for our Product class</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">    <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> Product<br>    {<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">virtual</span> Guid Id { get; set; }<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">virtual</span> <span style="color:#0000ff;">string</span> Name { get; set; }<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">virtual</span> <span style="color:#0000ff;">string</span> Category { get; set; }<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">virtual</span> <span style="color:#0000ff;">bool</span> Discontinued { get; set; }<br>    }</pre>
</div>
</div>
<p>Now run the test again. It should succeed and we get the following output</p>
<p><img src="TestOutput.png" alt=""></p>
<p>Note the sql spit out by NHibernate.</p>
<p>Now we think that we have successfully inserted a new product into the database. But let's test it whether it is really so. Let's extend our test method</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;height:313px;background-color:#f4f4f4;">
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        [Test]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_add_new_product()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            var product = <span style="color:#0000ff;">new</span> Product {Name = <span style="color:#006080;">"Apple"</span>, Category = <span style="color:#006080;">"Fruits"</span>};</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            IProductRepository repository = <span style="color:#0000ff;">new</span> ProductRepository();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            repository.Add(product);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            <span style="color:#008000;">// use session to try to load the product</span></pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            <span style="color:#0000ff;">using</span>(ISession session = _sessionFactory.OpenSession())</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                var fromDb = session.Get&lt;Product&gt;(product.Id);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                <span style="color:#008000;">// Test that the product was successfully inserted</span></pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                Assert.IsNotNull(fromDb);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                Assert.AreNotSame(product, fromDb);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                Assert.AreEqual(product.Name, fromDb.Name);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                Assert.AreEqual(product.Category, fromDb.Category);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        }</pre>
</div>
</div>
</div>
<p>Run the test again. Hopefully it will succeed...</p>
<p>Now we are ready to implement also the other methods of the repository. For testing this we would rather have a repository (that is database table) already containing some products. Nothing easier than this. Just add a method CreateInitialData to the test class as follows</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;height:355px;background-color:#f4f4f4;">
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"><span style="color:#0000ff;">private</span> <span style="color:#0000ff;">readonly</span> Product[] _products = <span style="color:#0000ff;">new</span>[]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                 {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                     <span style="color:#0000ff;">new</span> Product {Name = <span style="color:#006080;">"Melon"</span>, Category = <span style="color:#006080;">"Fruits"</span>},</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                     <span style="color:#0000ff;">new</span> Product {Name = <span style="color:#006080;">"Pear"</span>, Category = <span style="color:#006080;">"Fruits"</span>},</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                     <span style="color:#0000ff;">new</span> Product {Name = <span style="color:#006080;">"Milk"</span>, Category = <span style="color:#006080;">"Beverages"</span>},</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                     <span style="color:#0000ff;">new</span> Product {Name = <span style="color:#006080;">"Coca Cola"</span>, Category = <span style="color:#006080;">"Beverages"</span>},</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                     <span style="color:#0000ff;">new</span> Product {Name = <span style="color:#006080;">"Pepsi Cola"</span>, Category = <span style="color:#006080;">"Beverages"</span>},</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                 };</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">void</span> CreateInitialData()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            <span style="color:#0000ff;">using</span>(ISession session = _sessionFactory.OpenSession())</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                <span style="color:#0000ff;">using</span>(ITransaction transaction = session.BeginTransaction())</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                    <span style="color:#0000ff;">foreach</span> (var product <span style="color:#0000ff;">in</span> _products)</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                        session.Save(product);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                    transaction.Commit();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        }</pre>
</div>
</div>
</div>
<p>Call this method from the SetupContext method (after the create schema call) and we are done. Now each time after the database schema is created the database is populated with some products.</p>
<p>Let's test the Update method of the repository with the following code</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;height:269px;background-color:#f4f4f4;">
<div style="border-style:none;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        [Test]</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_update_existing_product()</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            var product = _products[0];</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            product.Name = <span style="color:#006080;">"Yellow Pear"</span>;</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            IProductRepository repository = <span style="color:#0000ff;">new</span> ProductRepository();</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            repository.Update(product);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;"> </pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            <span style="color:#008000;">// use session to try to load the product</span></pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            <span style="color:#0000ff;">using</span> (ISession session = _sessionFactory.OpenSession())</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">            {</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">                var fromDb = session.Get&lt;Product&gt;(product.Id);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">                Assert.AreEqual(product.Name, fromDb.Name);</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">            }</pre>
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:white;">        }</pre>
</div>
</div>
</div>
<p>When running for the first time this code will fail since the Update method has not yet been implemented in the repository. <b>Note</b>: This is the expected behavior since in TDD the first time you run a test it should always fail!</p>
<p>Analogous to the Add method we implement the Update method of the repository. The only difference is that we call the update method of the NHibernate session object instead of the save method.</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Update(Product product)<br>        {<br>            <span style="color:#0000ff;">using</span> (ISession session = NHibernateHelper.OpenSession())<br>            <span style="color:#0000ff;">using</span> (ITransaction transaction = session.BeginTransaction())<br>            {<br>                session.Update(product);<br>                transaction.Commit();<br>            }<br>        }</pre>
</div>
</div>
<p>Run the test again an watch it succeed.</p>
<p><img src="TestSucceed.png" alt=""></p>
<p>The delete method is straight forward. When testing whether the record has really been deleted we just assert that the value returned by the session's get method is equal to null. Here is the test method</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;height:227px;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">       [Test]<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_remove_existing_product()<br>        {<br>            var product = _products[0];<br>            IProductRepository repository = <span style="color:#0000ff;">new</span> ProductRepository();<br>            repository.Remove(product);<br> <br>            <span style="color:#0000ff;">using</span> (ISession session = _sessionFactory.OpenSession())<br>            {<br>                var fromDb = session.Get&lt;Product&gt;(product.Id);<br>                Assert.IsNull(fromDb);<br>            }<br>        }</pre>
</div>
</div>
<p>and here the implementation of the Remove method in the repository</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Remove(Product product)<br>        {<br>            <span style="color:#0000ff;">using</span> (ISession session = NHibernateHelper.OpenSession())<br>                <span style="color:#0000ff;">using</span> (ITransaction transaction = session.BeginTransaction())<br>                {<br>                    session.Delete(product);<br>                    transaction.Commit();<br>                }<br>        }</pre>
</div>
</div>
<h6><b>Querying the Database</b></h6>
<p>We still have to implement the three methods which query the database for objects. Let's start with the most easy one, the GetById. First we write the test</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        [Test]<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_get_existing_product_by_id()<br>        {<br>            IProductRepository repository = <span style="color:#0000ff;">new</span> ProductRepository();<br>            var fromDb = repository.GetById(_products[1].Id);<br>            Assert.IsNotNull(fromDb);<br>            Assert.AreNotSame(_products[1], fromDb);<br>            Assert.AreEqual(_products[1].Name, fromDb.Name);<br>        }</pre>
</div>
</div>
<p>and then the code to fulfill the test</p>
<div>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> Product GetById(Guid productId)<br>        {<br>            <span style="color:#0000ff;">using</span> (ISession session = NHibernateHelper.OpenSession())<br>                <span style="color:#0000ff;">return</span> session.Get&lt;Product&gt;(productId);<br>        }</pre>
</div>
</div>
</div>
<p>Now that was easy. For the following two methods we use a new method of the session object. Let's start with the GetByName method. As usual we write the test first</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">       [Test]<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_get_existing_product_by_name()<br>        {<br>            IProductRepository repository = <span style="color:#0000ff;">new</span> ProductRepository();<br>            var fromDb = repository.GetByName(_products[1].Name);<br> <br>            Assert.IsNotNull(fromDb);<br>            Assert.AreNotSame(_products[1], fromDb);<br>            Assert.AreEqual(_products[1].Id, fromDb.Id);<br>        }</pre>
</div>
</div>
<p>The implementation of the GetByName method can be done by using two different approaches. The first is using HQL (Hibernate Query Language) and the second one HCQ (Hibernate Criteria Query). Let's start with HQL. HQL is a object oriented query language similar (but not equal to) SQL.</p>
<p> </p>
<p>To be added: implemetation of GetByName using HQL. Implement HCQ as below this works as expected and returns a product entity.</p>
<p>In the above sample I have introduced a commonly used technique when using NHibernate. It's called <a href="http://en.wikipedia.org/wiki/Fluent_interface">fluent interfaces</a>. As a result the code is less verbose and easier to understand. You can see that a HQL query is a string which can have embedded (named) parameters. Parameters are prefixed by a ':'. NHibernate defines many helper methods (like SetString used in the example) to assign values of various types to those parameters. Finally by using UniqueResult I tell NHibernate that I expect only one record to return. If more than one record is returned by the HQL query then an exception is raised. To get more information about HQL please read the <a href="http://www.hibernate.org/hib_docs/nhibernate/1.2/reference/en/html/queryhql.html">online documentation</a>.</p>
<p>The second version uses a criteria query to search the requested product. You need to add a reference to  NHibernate.Criterion on your repository page.</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> Product GetByName(<span style="color:#0000ff;">string</span> name)<br>        {<br>            <span style="color:#0000ff;">using</span> (ISession session = NHibernateHelper.OpenSession())<br>            {<br>                Product product = session<br>                    .CreateCriteria(<span style="color:#0000ff;">typeof</span>(Product))<br>                    .Add(Restrictions.Eq(<span style="color:#006080;">"Name"</span>, name))<br>                    .UniqueResult&lt;Product&gt;();<br>                <span style="color:#0000ff;">return</span> product;<br>            }<br>        }</pre>
</div>
</div>
<p>Many users of NHibernate think that this approach is more object oriented. On the other hand a complex query written with criteria syntax can quickly become difficult to understand.</p>
<p>The last method to implement is GetByCategory. This method returns a list of products. The test can be implemented as follows</p>
<div>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;height:314px;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        [Test]<br>        <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Can_get_existing_products_by_category()<br>        {<br>            IProductRepository repository = <span style="color:#0000ff;">new</span> ProductRepository();<br>            var fromDb = repository.GetByCategory(<span style="color:#006080;">"Fruits"</span>);<br> <br>            Assert.AreEqual(2, fromDb.Count);<br>            Assert.IsTrue(IsInCollection(_products[0], fromDb));<br>            Assert.IsTrue(IsInCollection(_products[1], fromDb));<br>        }<br> <br>        <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">bool</span> IsInCollection(Product product, ICollection&lt;Product&gt; fromDb)<br>        {<br>            <span style="color:#0000ff;">foreach</span> (var item <span style="color:#0000ff;">in</span> fromDb)<br>                <span style="color:#0000ff;">if</span> (product.Id == item.Id)<br>                    <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">true</span>;<br>            <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">false</span>;<br>        }</pre>
</div>
</div>
<p>and the method itself might contain the following code</p>
<div style="border:1px solid gray;margin:20px 0px 10px;padding:4px;overflow:auto;font-size:8pt;width:97.5%;cursor:text;max-height:200px;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">
<pre style="border-style:none;margin:0em;padding:0px;overflow:visible;font-size:8pt;width:100%;color:black;line-height:12pt;font-family:consolas,'Courier New',courier,monospace;background-color:#f4f4f4;">        <span style="color:#0000ff;">public</span> ICollection&lt;Product&gt; GetByCategory(<span style="color:#0000ff;">string</span> category)<br>        {<br>            <span style="color:#0000ff;">using</span> (ISession session = NHibernateHelper.OpenSession())<br>            {<br>                var products = session<br>                    .CreateCriteria(<span style="color:#0000ff;">typeof</span>(Product))<br>                    .Add(Restrictions.Eq(<span style="color:#006080;">"Category"</span>, category))<br>                    .List&lt;Product&gt;();<br>                <span style="color:#0000ff;">return</span> products;<br>            }<br>        }</pre>
</div>
<h4><b>Summary</b></h4>
<p>In this article I have shown you how to implement a basic sample domain, define the mapping to a database and how to configure NHibernate to be able to persist domain objects in the database. I have shown you how to typically write and test CRUD methods for your domain objects. I have taken MS SQL Compact Edition as sample database but any other supported database can be used (you only have to change the hibernate.cfg.xml file accordingly). Ee have no dependencies on external frameworks or tools other than the database and NHibernate itself (.NET of course never counts here). <a href="http://www.mustuniversity.com/programs/certificate/undergraduate-course-certificate.html"></a></p>
</div>
            </div>
        
        
    </div>
</div>





</div></div>
			    <div style="clear: both;"></div>
			    
			    
            </div>

