---
layout:
---
<!doctype html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <title>Chapter&nbsp;25.&nbsp;Example: Various Mappings</title><link rel="stylesheet" href="../shared/css/html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.65.1"><link rel="home" href="index.html" title="NHibernate - Relational Persistence for Idiomatic .NET"><link rel="up" href="index.html" title="NHibernate - Relational Persistence for Idiomatic .NET"><link rel="previous" href="example-weblog.html" title="Chapter&nbsp;24.&nbsp;Example: Weblog Application"><link rel="next" href="best-practices.html" title="Chapter&nbsp;26.&nbsp;Best Practices"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;25.&nbsp;Example: Various Mappings</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="example-weblog.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="best-practices.html">Next</a></td></tr></table><hr></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="example-mappings"></a>Chapter&nbsp;25.&nbsp;Example: Various Mappings</h2></div></div><div></div></div>{% include google_adsense.html %}<p>
        This chapter shows off some more complex association mappings.
    </p><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="example-mappings-emp"></a>25.1.&nbsp;Employer/Employee</h2></div></div><div></div></div><p>
            The following model of the relationship between <tt class="literal">Employer</tt> and 
            <tt class="literal">Employee</tt> uses an actual entity class (<tt class="literal">Employment</tt>) 
            to represent the association. This is done because there might be more than one
            period of employment for the same two parties. Components are used to model monetary 
            values and employee names.
        </p><div class="mediaobject" align="center"><img src="../shared/images/EmployerEmployee.png" align="middle"></div><p>
            Here's a possible mapping document:
        </p><pre class="programlisting">&lt;hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
    assembly="..." namespace="..."&gt;

    &lt;class name="Employer" table="employers"&gt;
        &lt;id name="Id"&gt;
            &lt;generator class="sequence"&gt;
                &lt;param name="sequence"&gt;employer_id_seq&lt;/param&gt;
            &lt;/generator&gt;
        &lt;/id&gt;
        &lt;property name="Name"/&gt;
    &lt;/class&gt;

    &lt;class name="Employment" table="employment_periods"&gt;

        &lt;id name="Id"&gt;
            &lt;generator class="sequence"&gt;
                &lt;param name="sequence"&gt;employment_id_seq&lt;/param&gt;
            &lt;/generator&gt;
        &lt;/id&gt;
        &lt;property name="StartDate" column="start_date"/&gt;
        &lt;property name="EndDate" column="end_date"/&gt;

        &lt;component name="HourlyRate" class="MonetaryAmount"&gt;
            &lt;property name="Amount"&gt;
                &lt;column name="hourly_rate" sql-type="NUMERIC(12, 2)"/&gt;
            &lt;/property&gt;
            &lt;property name="Currency" length="12"/&gt;
        &lt;/component&gt;

        &lt;many-to-one name="Employer" column="employer_id" not-null="true"/&gt;
        &lt;many-to-one name="Employee" column="employee_id" not-null="true"/&gt;

    &lt;/class&gt;

    &lt;class name="Employee" table="employees"&gt;
        &lt;id name="Id"&gt;
            &lt;generator class="sequence"&gt;
                &lt;param name="sequence"&gt;employee_id_seq&lt;/param&gt;
            &lt;/generator&gt;
        &lt;/id&gt;
        &lt;property name="TaxfileNumber"/&gt;
        &lt;component name="Name" class="Name"&gt;
            &lt;property name="FirstName"/&gt;
            &lt;property name="Initial"/&gt;
            &lt;property name="LastName"/&gt;
        &lt;/component&gt;
    &lt;/class&gt;

&lt;/hibernate-mapping&gt;</pre><p>
            And here's the table schema generated by <tt class="literal">SchemaExport</tt>.
        </p><pre class="programlisting">create table employers (
    Id BIGINT not null, 
    Name VARCHAR(255), 
    primary key (Id)
)

create table employment_periods (
    Id BIGINT not null,
    hourly_rate NUMERIC(12, 2),
    Currency VARCHAR(12), 
    employee_id BIGINT not null, 
    employer_id BIGINT not null, 
    end_date TIMESTAMP, 
    start_date TIMESTAMP, 
    primary key (Id)
)

create table employees (
    Id BIGINT not null, 
    FirstName VARCHAR(255), 
    Initial CHAR(1), 
    LastName VARCHAR(255), 
    TaxfileNumber VARCHAR(255), 
    primary key (Id)
)

alter table employment_periods 
    add constraint employment_periodsFK0 foreign key (employer_id) references employers
alter table employment_periods 
    add constraint employment_periodsFK1 foreign key (employee_id) references employees
create sequence employee_id_seq
create sequence employment_id_seq
create sequence employer_id_seq</pre></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="example-mappings-authorwork"></a>25.2.&nbsp;Author/Work</h2></div></div><div></div></div><p>
            Consider the following model of the relationships between <tt class="literal">Work</tt>,
            <tt class="literal">Author</tt> and <tt class="literal">Person</tt>. We represent the relationship
            between <tt class="literal">Work</tt> and <tt class="literal">Author</tt> as a many-to-many
            association. We choose to represent the relationship between <tt class="literal">Author</tt> 
            and <tt class="literal">Person</tt> as one-to-one association. Another possibility would be to 
            have <tt class="literal">Author</tt> extend <tt class="literal">Person</tt>.  
        </p><div class="mediaobject" align="center"><img src="../shared/images/AuthorWork.png" align="middle"></div><p>
            The following mapping document correctly represents these relationships:
        </p><pre class="programlisting">&lt;hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
    assembly="..." namespace="..."&gt;

    &lt;class name="Work" table="works" discriminator-value="W"&gt;

        &lt;id name="Id" column="id" generator="native" /&gt;

        &lt;discriminator column="type" type="character"/&gt;

        &lt;property name="Title"/&gt;
        &lt;set name="Authors" table="author_work" lazy="true"&gt;
            &lt;key&gt;
                &lt;column name="work_id" not-null="true"/&gt;
            &lt;/key&gt;
            &lt;many-to-many class="Author"&gt;
                &lt;column name="author_id" not-null="true"/&gt;
            &lt;/many-to-many&gt;
        &lt;/set&gt;

        &lt;subclass name="Book" discriminator-value="B"&gt;
            &lt;property name="Text" column="text" /&gt;
        &lt;/subclass&gt;

        &lt;subclass name="Song" discriminator-value="S"&gt;
            &lt;property name="Tempo" column="tempo" /&gt;
            &lt;property name="Genre" column="genre" /&gt;
        &lt;/subclass&gt;

    &lt;/class&gt;

    &lt;class name="Author" table="authors"&gt;

        &lt;id name="Id" column="id"&gt;
            &lt;!-- The Author must have the same identifier as the Person --&gt;
            &lt;generator class="assigned"/&gt; 
        &lt;/id&gt;

        &lt;property name="Alias" column="alias" /&gt;
        &lt;one-to-one name="Person" constrained="true"/&gt;

        &lt;set name="Works" table="author_work" inverse="true" lazy="true"&gt;
            &lt;key column="author_id"/&gt;
            &lt;many-to-many class="Work" column="work_id"/&gt;
        &lt;/set&gt;

    &lt;/class&gt;

    &lt;class name="Person" table="persons"&gt;
        &lt;id name="Id" column="id"&gt;
            &lt;generator class="native"/&gt;
        &lt;/id&gt;
        &lt;property name="Name" column="name" /&gt;
    &lt;/class&gt;

&lt;/hibernate-mapping&gt;</pre><p>
            There are four tables in this mapping. <tt class="literal">works</tt>, 
            <tt class="literal">authors</tt> and <tt class="literal">persons</tt> hold work, author
            and person data respectively. <tt class="literal">author_work</tt> is an association
            table linking authors to works. Here is the table schema, as generated by
            <tt class="literal">SchemaExport</tt>.
        </p><pre class="programlisting">create table works (
    id BIGINT not null generated by default as identity, 
    tempo FLOAT, 
    genre VARCHAR(255), 
    text INTEGER, 
    title VARCHAR(255), 
    type CHAR(1) not null, 
    primary key (id)
)

create table author_work (
    author_id BIGINT not null, 
    work_id BIGINT not null, 
    primary key (work_id, author_id)
)

create table authors (
    id BIGINT not null generated by default as identity, 
    alias VARCHAR(255), 
    primary key (id)
)

create table persons (
    id BIGINT not null generated by default as identity, 
    name VARCHAR(255), 
    primary key (id)
)

alter table authors 
    add constraint authorsFK0 foreign key (id) references persons
alter table author_work 
    add constraint author_workFK0 foreign key (author_id) references authors
alter table author_work
    add constraint author_workFK1 foreign key (work_id) references works</pre></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="example-mappings-customerorderproduct"></a>25.3.&nbsp;Customer/Order/Product</h2></div></div><div></div></div><p>
            In this section we consider a model of the relationships between <tt class="literal">Customer</tt>,
            <tt class="literal">Order</tt>, <tt class="literal">LineItem</tt> and <tt class="literal">Product</tt>.
            There is a one-to-many association between <tt class="literal">Customer</tt> and
            <tt class="literal">Order</tt>, but how can you represent <tt class="literal">Order</tt> /
            <tt class="literal">LineItem</tt> / <tt class="literal">Product</tt>? In the example,
            <tt class="literal">LineItem</tt> is mapped as an association class representing the many-to-many
            association between <tt class="literal">Order</tt> and <tt class="literal">Product</tt>. In
            NHibernate, this is called a composite element.
        </p><div class="mediaobject" align="center"><img src="../shared/images/CustomerOrderProduct.png" align="middle"></div><p>
            The mapping document:
        </p><pre class="programlisting">&lt;hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
    assembly="..." namespace="..."&gt;

    &lt;class name="Customer" table="customers"&gt;
        &lt;id name="Id" column="id" generator="native" /&gt;
        &lt;property name="Name" column="name"/&gt;
        &lt;set name="Orders" inverse="true" lazy="true"&gt;
            &lt;key column="customer_id"/&gt;
            &lt;one-to-many class="Order"/&gt;
        &lt;/set&gt;
    &lt;/class&gt;

    &lt;class name="Order" table="orders"&gt;
        &lt;id name="Id" column="id" generator="native" /&gt;
        &lt;property name="Date" column="date"/&gt;
        &lt;many-to-one name="Customer" column="customer_id"/&gt;
        &lt;list name="LineItems" table="line_items" lazy="true"&gt;
            &lt;key column="order_id"/&gt;
            &lt;list-index column="line_number"/&gt;
            &lt;composite-element class="LineItem"&gt;
                &lt;property name="Quantity" column="quantity"/&gt;
                &lt;many-to-one name="Product" column="product_id"/&gt;
            &lt;/composite-element&gt;
        &lt;/list&gt;
    &lt;/class&gt;

    &lt;class name="Product" table="products"&gt;
        &lt;id name="Id" column="id"&gt;
            &lt;generator class="native"/&gt;
        &lt;/id&gt;
        &lt;property name="SerialNumber" column="serial_number" /&gt;
    &lt;/class&gt;

&lt;/hibernate-mapping&gt;</pre><p>
            <tt class="literal">customers</tt>, <tt class="literal">orders</tt>, <tt class="literal">line_items</tt> and 
            <tt class="literal">products</tt> hold customer, order, order line item and product data
            respectively. <tt class="literal">line_items</tt> also acts as an association table linking
            orders with products.
        </p><pre class="programlisting">create table customers (
    id BIGINT not null generated by default as identity, 
    name VARCHAR(255), 
    primary key (id)
)

create table orders (
    id BIGINT not null generated by default as identity, 
    customer_id BIGINT, 
    date TIMESTAMP, 
    primary key (id)
)

create table line_items (
    line_number INTEGER not null, 
    order_id BIGINT not null, 
    product_id BIGINT, 
    quantity INTEGER, 
    primary key (order_id, line_number)
)

create table products (
    id BIGINT not null generated by default as identity, 
    serial_number VARCHAR(255), 
    primary key (id)
)

alter table orders 
    add constraint ordersFK0 foreign key (customer_id) references customers
alter table line_items
    add constraint line_itemsFK0 foreign key (product_id) references products
alter table line_items
    add constraint line_itemsFK1 foreign key (order_id) references orders</pre></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="example-mappings-miscellaneous"></a>25.4.&nbsp;Miscellaneous example mappings</h2></div></div><div></div></div><p>
            These examples have been elaborated from the Hibernate test suite. You will find many other
            useful example mappings in NHibernate own test suite by searching in the test folder of the
            NHibernate sources.
        </p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="example-mappings-miscellaneous-typed121"></a>25.4.1.&nbsp;"Typed" one-to-one association</h3></div></div><div></div></div><pre class="programlisting">&lt;class name="Person"&gt;
    &lt;id name="Name"/&gt;
    &lt;one-to-one name="Address" cascade="all"&gt;
        &lt;formula&gt;Name&lt;/formula&gt;
        &lt;formula&gt;'HOME'&lt;/formula&gt;
    &lt;/one-to-one&gt;
    &lt;one-to-one name="MailingAddress" cascade="all"&gt;
        &lt;formula&gt;Name&lt;/formula&gt;
        &lt;formula&gt;'MAILING'&lt;/formula&gt;
    &lt;/one-to-one&gt;
&lt;/class&gt;

&lt;class name="Address" batch-size="2"
        check="addressType in ('MAILING', 'HOME', 'BUSINESS')"&gt;
    &lt;composite-id&gt;
        &lt;key-many-to-one name="Person" column="personName"/&gt;
        &lt;key-property name="Type" column="addressType"/&gt;
    &lt;/composite-id&gt;
    &lt;property name="Street" type="text"/&gt;
    &lt;property name="State"/&gt;
    &lt;property name="Zip"/&gt;
&lt;/class&gt;</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="example-mappings-miscellaneous-compositekey"></a>25.4.2.&nbsp;Composite key example</h3></div></div><div></div></div><pre class="programlisting">&lt;class name="Customer"&gt;
    &lt;id name="CustomerId" length="10"&gt;
        &lt;generator class="assigned"/&gt;
    &lt;/id&gt;

    &lt;property name="Name" not-null="true" length="100"/&gt;
    &lt;property name="Address" not-null="true" length="200"/&gt;

    &lt;list name="Orders" inverse="true" cascade="save-update"&gt;
        &lt;key column="CustomerId"/&gt;
        &lt;list-index column="OrderNumber"/&gt;
        &lt;one-to-many class="Order"/&gt;
    &lt;/list&gt;
&lt;/class&gt;

&lt;class name="Order" table="CustomerOrder"&gt;
    &lt;synchronize table="LineItem"/&gt;
    &lt;synchronize table="Product"/&gt;

    &lt;composite-id name="Id" class="Order+Id"&gt;
        &lt;key-property name="CustomerId" length="10"/&gt;
        &lt;key-property name="OrderNumber"/&gt;
    &lt;/composite-id&gt;

    &lt;property name="OrderDate" type="date" not-null="true"/&gt;

    &lt;property name="Total"&gt;
        &lt;formula&gt;
            ( select sum(li.quantity * p.price)
            from LineItem li, Product p
            where li.productId = p.productId
                and li.customerId = customerId
                and li.orderNumber = orderNumber )
        &lt;/formula&gt;
    &lt;/property&gt;

    &lt;many-to-one name="Customer"
            column="CustomerId"
            insert="false"
            update="false"
            not-null="true"/&gt;

    &lt;bag name="LineItems"
            fetch="join"
            inverse="true"
            cascade="save-update"&gt;
        &lt;key&gt;
            &lt;column name="CustomerId"/&gt;
            &lt;column name="OrderNumber"/&gt;
        &lt;/key&gt;
        &lt;one-to-many class="LineItem"/&gt;
    &lt;/bag&gt;
&lt;/class&gt;

&lt;class name="LineItem"&gt;
    &lt;composite-id name="id" class="LineItem+Id"&gt;
        &lt;key-property name="CustomerId" length="10"/&gt;
        &lt;key-property name="OrderNumber"/&gt;
        &lt;key-property name="ProductId" length="10"/&gt;
    &lt;/composite-id&gt;

    &lt;property name="Quantity"/&gt;

    &lt;many-to-one name="Order" insert="false" update="false" not-null="true"&gt;
        &lt;column name="CustomerId"/&gt;
        &lt;column name="OrderNumber"/&gt;
    &lt;/many-to-one&gt;

    &lt;many-to-one name="Product"
            insert="false"
            update="false"
            not-null="true"
            column="ProductId"/&gt;
&lt;/class&gt;

&lt;class name="Product"&gt;
    &lt;synchronize table="LineItem"/&gt;

    &lt;id name="ProductId" length="10"&gt;
        &lt;generator class="assigned"/&gt;
    &lt;/id&gt;

    &lt;property name="Description" not-null="true" length="200"/&gt;
    &lt;property name="Price" length="3"/&gt;
    &lt;property name="NumberAvailable"/&gt;

    &lt;property name="NumberOrdered"&gt;
        &lt;formula&gt;
            ( select sum(li.quantity)
            from LineItem li
            where li.productId = productId )
        &lt;/formula&gt;
    &lt;/property&gt;
&lt;/class&gt;</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="example-mappings-miscellaneous-m2mcomposite"></a>25.4.3.&nbsp;Many-to-many with shared composite key attribute</h3></div></div><div></div></div><pre class="programlisting">&lt;class name="User" table="`User`"&gt;
    &lt;composite-id&gt;
        &lt;key-property name="Name"/&gt;
        &lt;key-property name="Org"/&gt;
    &lt;/composite-id&gt;
    &lt;set name="Groups" table="UserGroup"&gt;
        &lt;key&gt;
            &lt;column name="UserName"/&gt;
            &lt;column name="Org"/&gt;
        &lt;/key&gt;
        &lt;many-to-many class="Group"&gt;
            &lt;column name="GroupName"/&gt;
            &lt;formula&gt;Org&lt;/formula&gt;
        &lt;/many-to-many&gt;
    &lt;/set&gt;
&lt;/class&gt;

&lt;class name="Group" table="`Group`"&gt;
    &lt;composite-id&gt;
        &lt;key-property name="Name"/&gt;
        &lt;key-property name="Org"/&gt;
    &lt;/composite-id&gt;
    &lt;property name="Description"/&gt;
    &lt;set name="Users" table="UserGroup" inverse="true"&gt;
        &lt;key&gt;
            &lt;column name="GroupName"/&gt;
            &lt;column name="Org"/&gt;
        &lt;/key&gt;
        &lt;many-to-many class="User"&gt;
            &lt;column name="UserName"/&gt;
            &lt;formula&gt;Org&lt;/formula&gt;
        &lt;/many-to-many&gt;
    &lt;/set&gt;
&lt;/class&gt;</pre><p>
                This case requires mixing column and formula under the <tt class="literal">&lt;many-to-many&gt;</tt>
                element, which is supported only since NHibernate 5.2.
            </p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="example-mappings-miscellaneous-contentdiscriminator"></a>25.4.4.&nbsp;Content based discrimination</h3></div></div><div></div></div><pre class="programlisting">&lt;class name="Person" discriminator-value="P"&gt;
    &lt;id name="Id" column="person_id"&gt;
        &lt;generator class="native"/&gt;
    &lt;/id&gt;

    &lt;discriminator type="character"&gt;
        &lt;formula&gt;
            case
                when Title is not null then 'E'
                when Salesperson is not null then 'C'
                else 'P'
            end
        &lt;/formula&gt;
    &lt;/discriminator&gt;

    &lt;property name="Name" not-null="true" length="80"/&gt;
    &lt;property name="Sex" not-null="true" update="false"/&gt;

    &lt;component name="Address"&gt;
        &lt;property name="Address"/&gt;
        &lt;property name="Zip"/&gt;
        &lt;property name="Country"/&gt;
    &lt;/component&gt;

    &lt;subclass name="Employee" discriminator-value="E"&gt;
        &lt;property name="Title" length="20"/&gt;
        &lt;property name="Salary"/&gt;
        &lt;many-to-one name="Manager"/&gt;
    &lt;/subclass&gt;

    &lt;subclass name="Customer" discriminator-value="C"&gt;
        &lt;property name="Comments"/&gt;
        &lt;many-to-one name="Salesperson"/&gt;
    &lt;/subclass&gt;
&lt;/class&gt;</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="example-mappings-miscellaneous-propertyref"></a>25.4.5.&nbsp;Associations on alternate keys</h3></div></div><div></div></div><pre class="programlisting">&lt;class name="Person"&gt;
    &lt;id name="Id"&gt;
        &lt;generator class="hilo"/&gt;
    &lt;/id&gt;

    &lt;property name="Name" length="100"/&gt;

    &lt;one-to-one name="Address"
        property-ref="Person"
        cascade="all"
        fetch="join"/&gt;

    &lt;set name="accounts" inverse="true"&gt;
        &lt;key column="UserId" property-ref="User"/&gt;
        &lt;one-to-many class="Account"/&gt;
    &lt;/set&gt;

    &lt;property name="UserId" length="8"/&gt;
&lt;/class&gt;

&lt;class name="Address"&gt;
    &lt;id name="Id"&gt;
        &lt;generator class="hilo"/&gt;
    &lt;/id&gt;

    &lt;property name="Address" length="300"/&gt;
    &lt;property name="Zip" length="5"/&gt;
    &lt;property name="Country" length="25"/&gt;
    &lt;many-to-one name="Person" unique="true" not-null="true"/&gt;
&lt;/class&gt;

&lt;class name="Account"&gt;
    &lt;id name="AccountId" length="32"&gt;
        &lt;generator class="uuid"/&gt;
    &lt;/id&gt;

    &lt;many-to-one name="User"
        column="UserId"
        property-ref="UserId"/&gt;

    &lt;property name="Type" not-null="true"/&gt;
&lt;/class&gt;</pre></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="example-weblog.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="index.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="best-practices.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;24.&nbsp;Example: Weblog Application&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;26.&nbsp;Best Practices</td></tr></table></div>{% include google_analytics.html %}{% include metrika_yandex_ru.html %}</body></html>